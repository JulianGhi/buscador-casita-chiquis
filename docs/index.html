<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador Casita Chiquis</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>
  <script>
    // Defaults
    const DEFAULT_CONFIG = {
      SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-bXC7r4bVh2Hc6Wovv-EFfb30nUMB5X3HA4NQoSTAZ-r6di3dhUEsdUNSHhebr8ezg0dIbw8nAA8S/pub?output=csv',
      CREDITO: 86000,
      PRESUPUESTO: 25000,
      MARGEN_REF: 0.12,
      ESCRIBANO: 0.0242,
      SELLOS_EXENTO: 140000,
      SELLOS: 0.0175,
      REGISTRALES: 0.004,
      INMOB: 0.0484,
      HIPOTECA: 0.01,
      CERTIFICADOS: 300,
      AUTO_REFRESH: 60,  // segundos, 0 = desactivado
    };

    const DEFAULT_REF_M2 = {
      "Flores": 1953, "Parque Chacabuco": 1951, "Liniers": 1857, "Monte Castro": 1854,
      "Floresta": 1683, "Parque Avellaneda": 1750, "Villa Luro": 1785, "V√©lez Sarsfield": 1663,
      "Mataderos": 1629, "Paternal": 1897, "Caballito": 2357, "Villa Crespo": 2150,
      "Villa del Parque": 2063, "Villa Devoto": 2348, "Boedo": 1876
    };

    // Load from localStorage or use defaults
    function loadConfig() {
      try {
        const saved = localStorage.getItem('casita_config');
        return saved ? { ...DEFAULT_CONFIG, ...JSON.parse(saved) } : { ...DEFAULT_CONFIG };
      } catch { return { ...DEFAULT_CONFIG }; }
    }

    function loadRefM2() {
      try {
        const saved = localStorage.getItem('casita_ref_m2');
        return saved ? JSON.parse(saved) : { ...DEFAULT_REF_M2 };
      } catch { return { ...DEFAULT_REF_M2 }; }
    }

    function saveConfig(config) {
      localStorage.setItem('casita_config', JSON.stringify(config));
    }

    function saveRefM2(refM2) {
      localStorage.setItem('casita_ref_m2', JSON.stringify(refM2));
    }

    let CONFIG = loadConfig();
    let REF_M2 = loadRefM2();

    const SAMPLE_CSV = `id,direccion,barrio,precio,m2_cub,m2_tot,m2_terr,amb,apto_credito,terraza,expensas,inmobiliaria,status,notas,link,online
1,Av Juan B Alberdi 4600,Parque Avellaneda,105000,70,140,70,3,si,si,,GOLDEN HAUS,Por ver,40 a√±os sin expensas,https://www.argenprop.com/ficha--17094976,online
2,Segurola 1700,Monte Castro,89000,70,,,3,si,si,,,Por ver,95 a√±os apto cr√©dito,,?meli
3,Gualeguaych√∫ 985,Floresta,95000,79,,,4,si,si,15000,,Por ver,Terraza con parrilla,,?meli
4,Chivilcoy (Plaza V√©lez),Floresta,98000,71,,,3,si,si,,,Por ver,Terraza + balc√≥n,,?meli
5,Mercedes 1432,Floresta,110000,83,,,3,si,si,,Inmobiliaria,Por ver,Reciclado terraza oficina,,online
6,T√∫pac Amaru 1100,Floresta,95000,64,138,,3,si,,,Argenprop,Por ver,64m¬≤ cub 138m¬≤ tot,,online`;

    let state = {
      rawData: '',
      loading: false,
      error: null,
      lastUpdate: null,
      manualUrl: CONFIG.SHEET_URL,
      filterStatus: 'todos',
      filterOk: 'todos',
      filterBarrio: 'todos',
      filterOnline: 'todos',
      sortBy: 'precio',
      sortDir: 'asc',
      showConfig: false,
      configTab: 'general',
      autoRefreshEnabled: CONFIG.AUTO_REFRESH > 0,
      nextRefresh: null
    };

    let autoRefreshInterval = null;

    function startAutoRefresh() {
      stopAutoRefresh();
      if (CONFIG.AUTO_REFRESH > 0 && state.manualUrl) {
        state.autoRefreshEnabled = true;
        autoRefreshInterval = setInterval(() => {
          fetchData(state.manualUrl);
        }, CONFIG.AUTO_REFRESH * 1000);
      }
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
      state.autoRefreshEnabled = false;
    }

    function toggleAutoRefresh() {
      if (state.autoRefreshEnabled) {
        stopAutoRefresh();
      } else {
        startAutoRefresh();
      }
      render();
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, '_'));
      return lines.slice(1).map((line, idx) => {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (const char of line) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());
        const obj = { _idx: idx };
        headers.forEach((h, i) => { obj[h] = values[i] || ''; });
        return obj;
      });
    }

    function calculateProperty(p) {
      const precio = parseFloat(p.precio) || 0;
      const m2 = parseFloat(p.m2_cub) || 0;
      const barrio = p.barrio;
      const tieneInmob = p.inmobiliaria && p.inmobiliaria.trim() !== '';
      const calc = { ...p, _precio: precio, _m2: m2, _preciom2: m2 > 0 ? Math.round(precio / m2) : 0, _ref: REF_M2[barrio] || 0 };
      calc._vsRef = calc._ref > 0 ? (calc._preciom2 - calc._ref) / calc._ref : 0;
      calc._tu10 = Math.max(precio - CONFIG.CREDITO, precio * 0.1);
      calc._escr = Math.round(precio * CONFIG.ESCRIBANO);
      calc._sell = precio <= CONFIG.SELLOS_EXENTO ? 0 : Math.round(precio * CONFIG.SELLOS);
      calc._reg = Math.round(precio * CONFIG.REGISTRALES);
      calc._inmob = tieneInmob ? Math.round(precio * CONFIG.INMOB) : 0;
      calc._hip = Math.round(precio * CONFIG.HIPOTECA);
      calc._cert = CONFIG.CERTIFICADOS;
      calc._total = calc._tu10 + calc._escr + calc._sell + calc._reg + calc._inmob + calc._hip + calc._cert;
      calc._ok = calc._total <= CONFIG.PRESUPUESTO;
      calc._dif = CONFIG.PRESUPUESTO - calc._total;
      return calc;
    }

    async function fetchData(url) {
      if (!url) {
        state.rawData = SAMPLE_CSV;
        state.lastUpdate = new Date();
        state.error = null;
        render();
        return;
      }
      state.loading = true;
      state.error = null;
      render();
      try {
        const corsProxy = 'https://corsproxy.io/?';
        const response = await fetch(corsProxy + encodeURIComponent(url));
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const text = await response.text();
        state.rawData = text;
        state.lastUpdate = new Date();
      } catch (err) {
        state.error = `Error cargando datos: ${err.message}`;
        state.rawData = SAMPLE_CSV;
      }
      state.loading = false;
      render();
    }

    function getProperties() {
      return parseCSV(state.rawData).map(calculateProperty).filter(p => p._precio > 0);
    }

    function getFiltered(properties) {
      let result = [...properties];
      if (state.filterStatus !== 'todos') result = result.filter(p => p.status?.toLowerCase().includes(state.filterStatus.toLowerCase()));
      if (state.filterOk === 'ok') result = result.filter(p => p._ok);
      else if (state.filterOk === 'no') result = result.filter(p => !p._ok);
      if (state.filterBarrio !== 'todos') result = result.filter(p => p.barrio === state.filterBarrio);
      if (state.filterOnline !== 'todos') result = result.filter(p => p.online?.toLowerCase().includes(state.filterOnline.toLowerCase()));
      result.sort((a, b) => {
        let va = a['_' + state.sortBy] ?? a[state.sortBy] ?? 0;
        let vb = b['_' + state.sortBy] ?? b[state.sortBy] ?? 0;
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        return state.sortDir === 'asc' ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
      return result;
    }

    function getStats(properties) {
      return {
        total: properties.length,
        entran: properties.filter(p => p._ok).length,
        online: properties.filter(p => p.online?.toLowerCase() === 'online').length,
        porVer: properties.filter(p => p.status?.toLowerCase().includes('por ver')).length,
        minPrecio: properties.length > 0 ? Math.min(...properties.map(p => p._precio)) : 0,
        maxPrecio: properties.length > 0 ? Math.max(...properties.map(p => p._precio)) : 0,
      };
    }

    function evalIcon(vsRef) {
      if (!vsRef && vsRef !== 0) return '<span class="text-gray-300">-</span>';
      if (vsRef < -CONFIG.MARGEN_REF) return '<span title="Bajo mercado">üü¢</span>';
      if (vsRef > CONFIG.MARGEN_REF) return '<span title="Sobre mercado">üî¥</span>';
      return '<span title="En mercado">üü°</span>';
    }

    function okPill(ok) {
      return ok
        ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚úì</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">‚úó</span>';
    }

    function onlineBadge(status) {
      if (!status) return '<span class="text-gray-300">-</span>';
      const s = status.toLowerCase();
      if (s === 'online') return '<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">Online</span>';
      if (s === 'baja') return '<span class="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded">Baja</span>';
      return `<span class="text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">${status}</span>`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function updateConfig(key, value) {
      CONFIG[key] = value;
      saveConfig(CONFIG);
      render();
    }

    function updateRefM2(barrio, value) {
      if (value === '' || value === null) {
        delete REF_M2[barrio];
      } else {
        REF_M2[barrio] = parseInt(value) || 0;
      }
      saveRefM2(REF_M2);
      render();
    }

    function addBarrio() {
      const nombre = prompt('Nombre del barrio:');
      if (nombre && nombre.trim()) {
        const valor = prompt('$/m¬≤ de referencia:');
        if (valor) {
          REF_M2[nombre.trim()] = parseInt(valor) || 0;
          saveRefM2(REF_M2);
          render();
        }
      }
    }

    function deleteBarrio(barrio) {
      if (confirm(`¬øEliminar ${barrio}?`)) {
        delete REF_M2[barrio];
        saveRefM2(REF_M2);
        render();
      }
    }

    function resetConfig() {
      if (confirm('¬øResetear toda la configuraci√≥n a los valores por defecto?')) {
        CONFIG = { ...DEFAULT_CONFIG };
        REF_M2 = { ...DEFAULT_REF_M2 };
        saveConfig(CONFIG);
        saveRefM2(REF_M2);
        state.manualUrl = CONFIG.SHEET_URL;
        render();
      }
    }

    function renderConfigPanel() {
      const tabClass = (tab) => state.configTab === tab
        ? 'px-3 py-1.5 text-sm font-medium text-blue-600 border-b-2 border-blue-600'
        : 'px-3 py-1.5 text-sm text-slate-500 hover:text-slate-700 cursor-pointer';

      return `
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4 border border-slate-200">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-medium text-slate-700">Configuraci√≥n</h3>
            <button onclick="resetConfig()" class="text-xs text-red-500 hover:text-red-700">Resetear todo</button>
          </div>

          <!-- Tabs -->
          <div class="flex border-b border-slate-200 mb-4">
            <button onclick="state.configTab='general';render()" class="${tabClass('general')}">General</button>
            <button onclick="state.configTab='gastos';render()" class="${tabClass('gastos')}">Gastos</button>
            <button onclick="state.configTab='barrios';render()" class="${tabClass('barrios')}">Barrios $/m¬≤</button>
          </div>

          ${state.configTab === 'general' ? `
            <!-- Google Sheet URL -->
            <div class="mb-4">
              <label class="block text-xs text-slate-500 mb-1">URL Google Sheet (CSV)</label>
              <div class="flex gap-2">
                <input type="text" id="urlInput" value="${escapeHtml(state.manualUrl)}" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" class="flex-1 px-3 py-2 border rounded-lg text-sm" />
                <button onclick="state.manualUrl=document.getElementById('urlInput').value;CONFIG.SHEET_URL=state.manualUrl;saveConfig(CONFIG);fetchData(state.manualUrl)" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">Conectar</button>
              </div>
              ${!state.manualUrl ? '<p class="text-xs text-amber-600 mt-1">Usando datos de ejemplo</p>' : ''}
            </div>

            <!-- Cr√©dito y Presupuesto -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-slate-500 mb-1">Monto cr√©dito hipotecario (USD)</label>
                <input type="number" value="${CONFIG.CREDITO}" onchange="updateConfig('CREDITO', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Presupuesto gastos (USD)</label>
                <input type="number" value="${CONFIG.PRESUPUESTO}" onchange="updateConfig('PRESUPUESTO', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Auto-refresh (seg, 0=off)</label>
                <input type="number" value="${CONFIG.AUTO_REFRESH}" onchange="updateConfig('AUTO_REFRESH', parseInt(this.value)); stopAutoRefresh();" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
            </div>
          ` : ''}

          ${state.configTab === 'gastos' ? `
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-slate-500 mb-1">Escribano (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.ESCRIBANO * 100).toFixed(2)}" onchange="updateConfig('ESCRIBANO', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Sellos (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.SELLOS * 100).toFixed(2)}" onchange="updateConfig('SELLOS', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Exento sellos hasta (USD)</label>
                <input type="number" value="${CONFIG.SELLOS_EXENTO}" onchange="updateConfig('SELLOS_EXENTO', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Registrales (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.REGISTRALES * 100).toFixed(2)}" onchange="updateConfig('REGISTRALES', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Inmobiliaria (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.INMOB * 100).toFixed(2)}" onchange="updateConfig('INMOB', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Hipoteca (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.HIPOTECA * 100).toFixed(2)}" onchange="updateConfig('HIPOTECA', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Certificados (USD fijo)</label>
                <input type="number" value="${CONFIG.CERTIFICADOS}" onchange="updateConfig('CERTIFICADOS', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Margen referencia (%)</label>
                <input type="number" step="1" value="${(CONFIG.MARGEN_REF * 100).toFixed(0)}" onchange="updateConfig('MARGEN_REF', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
            </div>
          ` : ''}

          ${state.configTab === 'barrios' ? `
            <div class="mb-3">
              <button onclick="addBarrio()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">+ Agregar barrio</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-64 overflow-y-auto">
              ${Object.entries(REF_M2).sort((a,b) => a[0].localeCompare(b[0])).map(([barrio, valor]) => `
                <div class="flex items-center gap-2 bg-slate-50 rounded-lg p-2">
                  <input type="number" value="${valor}" onchange="updateRefM2('${escapeHtml(barrio)}', this.value)" class="w-20 px-2 py-1 border rounded text-sm" />
                  <span class="text-sm text-slate-600 flex-1 truncate" title="${escapeHtml(barrio)}">${escapeHtml(barrio)}</span>
                  <button onclick="deleteBarrio('${escapeHtml(barrio)}')" class="text-red-400 hover:text-red-600 text-sm">‚úï</button>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }

    function render() {
      const properties = getProperties();
      const filtered = getFiltered(properties);
      const stats = getStats(properties);
      const barrios = [...new Set(properties.map(p => p.barrio).filter(Boolean))].sort();

      const root = document.getElementById('root');
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-3 md:p-6">
          <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
              <div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-800">üè† Buscador Casita Chiquis</h1>
                <p class="text-xs md:text-sm text-slate-500">Cr√©dito $${CONFIG.CREDITO.toLocaleString()} ¬∑ Presupuesto $${CONFIG.PRESUPUESTO.toLocaleString()}</p>
              </div>
              <div class="flex items-center gap-2">
                ${state.lastUpdate ? `<span class="text-xs text-slate-400">${state.lastUpdate.toLocaleTimeString()}</span>` : ''}
                <button onclick="fetchData(state.manualUrl)" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 disabled:opacity-50" ${state.loading ? 'disabled' : ''}>${state.loading ? '...' : '‚Üª'}</button>
                <button onclick="toggleAutoRefresh()" class="px-3 py-1.5 ${state.autoRefreshEnabled ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-700'} text-sm rounded-lg hover:opacity-80" title="Auto-refresh cada ${CONFIG.AUTO_REFRESH}s">${state.autoRefreshEnabled ? '‚è∏' : '‚ñ∂'}</button>
                <button onclick="state.showConfig=!state.showConfig;render()" class="px-3 py-1.5 ${state.showConfig ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-700'} text-sm rounded-lg hover:opacity-80">‚öôÔ∏è</button>
              </div>
            </div>

            <!-- Config Panel -->
            ${state.showConfig ? renderConfigPanel() : ''}

            <!-- Error -->
            ${state.error ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded-lg mb-4 text-sm">${escapeHtml(state.error)}</div>` : ''}

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 md:gap-3 mb-4">
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-slate-500">Total</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-green-600">${stats.entran}</div><div class="text-xs text-slate-500">Entran</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-red-600">${stats.total - stats.entran}</div><div class="text-xs text-slate-500">No entran</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-teal-600">${stats.online}</div><div class="text-xs text-slate-500">Online</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-purple-600">$${(stats.minPrecio/1000).toFixed(0)}k</div><div class="text-xs text-slate-500">Min</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-purple-600">$${(stats.maxPrecio/1000).toFixed(0)}k</div><div class="text-xs text-slate-500">Max</div></div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl p-3 shadow-sm mb-4">
              <div class="flex flex-wrap gap-2 md:gap-3 items-center text-sm">
                <select onchange="state.filterStatus=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterStatus === 'todos' ? 'selected' : ''}>Status: Todos</option>
                  <option value="por ver" ${state.filterStatus === 'por ver' ? 'selected' : ''}>Por ver</option>
                  <option value="visitado" ${state.filterStatus === 'visitado' ? 'selected' : ''}>Visitado</option>
                  <option value="interesado" ${state.filterStatus === 'interesado' ? 'selected' : ''}>Interesado</option>
                  <option value="descartado" ${state.filterStatus === 'descartado' ? 'selected' : ''}>Descartado</option>
                </select>
                <select onchange="state.filterOk=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterOk === 'todos' ? 'selected' : ''}>Presupuesto: Todos</option>
                  <option value="ok" ${state.filterOk === 'ok' ? 'selected' : ''}>‚úì Entra</option>
                  <option value="no" ${state.filterOk === 'no' ? 'selected' : ''}>‚úó No entra</option>
                </select>
                <select onchange="state.filterBarrio=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterBarrio === 'todos' ? 'selected' : ''}>Barrio: Todos</option>
                  ${barrios.map(b => `<option value="${escapeHtml(b)}" ${state.filterBarrio === b ? 'selected' : ''}>${escapeHtml(b)}</option>`).join('')}
                </select>
                <select onchange="state.filterOnline=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterOnline === 'todos' ? 'selected' : ''}>Online: Todos</option>
                  <option value="online" ${state.filterOnline === 'online' ? 'selected' : ''}>‚úì Online</option>
                  <option value="baja" ${state.filterOnline === 'baja' ? 'selected' : ''}>‚úó Baja</option>
                  <option value="?" ${state.filterOnline === '?' ? 'selected' : ''}>? Sin verificar</option>
                </select>
                <div class="flex items-center gap-1 ml-auto">
                  <select onchange="state.sortBy=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                    <option value="precio" ${state.sortBy === 'precio' ? 'selected' : ''}>Precio</option>
                    <option value="total" ${state.sortBy === 'total' ? 'selected' : ''}>Gastos</option>
                    <option value="dif" ${state.sortBy === 'dif' ? 'selected' : ''}>Diferencia</option>
                    <option value="preciom2" ${state.sortBy === 'preciom2' ? 'selected' : ''}>$/m¬≤</option>
                  </select>
                  <button onclick="state.sortDir=state.sortDir==='asc'?'desc':'asc';render()" class="px-2 py-1.5 border border-slate-200 rounded-lg bg-white hover:bg-slate-50">${state.sortDir === 'asc' ? '‚Üë' : '‚Üì'}</button>
                </div>
                <span class="text-slate-400 text-xs">${filtered.length}/${properties.length}</span>
              </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                      <th class="px-3 py-2.5 text-left font-medium text-slate-600">Direcci√≥n</th>
                      <th class="px-3 py-2.5 text-left font-medium text-slate-600">Barrio</th>
                      <th class="px-3 py-2.5 text-right font-medium text-slate-600">Precio</th>
                      <th class="px-3 py-2.5 text-right font-medium text-slate-600">m¬≤</th>
                      <th class="px-3 py-2.5 text-right font-medium text-slate-600">$/m¬≤</th>
                      <th class="px-3 py-2.5 text-center font-medium text-slate-600">Eval</th>
                      <th class="px-3 py-2.5 text-right font-medium text-slate-600">Gastos</th>
                      <th class="px-3 py-2.5 text-center font-medium text-slate-600">OK</th>
                      <th class="px-3 py-2.5 text-center font-medium text-slate-600">Online</th>
                      <th class="px-3 py-2.5 text-left font-medium text-slate-600">Notas</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">
                    ${filtered.map((p, i) => `
                      <tr class="hover:bg-slate-50 transition-colors ${p._ok ? 'bg-green-50/30' : ''}">
                        <td class="px-3 py-2.5">${p.link ? `<a href="${escapeHtml(p.link)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">${escapeHtml(p.direccion)}</a>` : `<span class="font-medium text-slate-800">${escapeHtml(p.direccion)}</span>`}</td>
                        <td class="px-3 py-2.5 text-slate-600">${escapeHtml(p.barrio)}</td>
                        <td class="px-3 py-2.5 text-right font-mono text-slate-800">$${p._precio.toLocaleString()}</td>
                        <td class="px-3 py-2.5 text-right text-slate-600">${p._m2 || '-'}</td>
                        <td class="px-3 py-2.5 text-right font-mono text-slate-600">${p._preciom2 > 0 ? `$${p._preciom2.toLocaleString()}${p._ref > 0 ? `<span class="text-slate-400 text-xs ml-1">(${p._ref})</span>` : ''}` : '-'}</td>
                        <td class="px-3 py-2.5 text-center">${evalIcon(p._vsRef)}</td>
                        <td class="px-3 py-2.5 text-right"><div class="font-mono text-slate-800">$${p._total.toLocaleString()}</div><div class="text-xs font-medium ${p._dif >= 0 ? 'text-green-600' : 'text-red-500'}">${p._dif >= 0 ? '+' : ''}${p._dif.toLocaleString()}</div></td>
                        <td class="px-3 py-2.5 text-center">${okPill(p._ok)}</td>
                        <td class="px-3 py-2.5 text-center">${onlineBadge(p.online)}</td>
                        <td class="px-3 py-2.5 text-slate-500 text-xs max-w-[200px] truncate" title="${escapeHtml(p.notas)}">${escapeHtml(p.notas)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              ${filtered.length === 0 ? '<div class="text-center py-8 text-slate-400">No hay propiedades que coincidan</div>' : ''}
            </div>

            <div class="text-center text-xs text-slate-400 mt-6">Buscador Casita Chiquis üè†</div>
          </div>
        </div>
      `;
    }

    // Initial load
    fetchData(state.manualUrl);
  </script>
</body>
</html>
