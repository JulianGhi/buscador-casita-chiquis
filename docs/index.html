<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador Casita Chiquis</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .modal-backdrop { background: rgba(0,0,0,0.5); }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    @keyframes pulse-heart {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .emoji-float { display: inline-block; animation: float 2s ease-in-out infinite; }
    .emoji-float:nth-child(2) { animation-delay: 0.2s; }
    .emoji-float:nth-child(3) { animation-delay: 0.4s; }
    .emoji-float:nth-child(4) { animation-delay: 0.6s; }
    .emoji-float:nth-child(5) { animation-delay: 0.8s; }
    .emoji-heart { display: inline-block; animation: pulse-heart 1s ease-in-out infinite; }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>
  <script>
    const DEFAULT_CONFIG = {
      CREDITO_ARS: 126000000,
      DOLAR_BASE: 1450,
      PRESUPUESTO: 25000,
      MARGEN_REF: 0.12,
      ESCRIBANO: 0.0242,
      SELLOS_EXENTO: 140000,
      SELLOS: 0.0175,
      REGISTRALES: 0.004,
      INMOB: 0.0484,
      HIPOTECA: 0.01,
      CERTIFICADOS: 300,
      AUTO_REFRESH: 10,
    };

    const DEFAULT_REF_M2 = {
      "Flores": 1953, "Parque Chacabuco": 1951, "Liniers": 1857, "Monte Castro": 1854,
      "Floresta": 1683, "Parque Avellaneda": 1750, "Villa Luro": 1785, "V√©lez Sarsfield": 1663,
      "Mataderos": 1629, "Paternal": 1897, "Caballito": 2357, "Villa Crespo": 2150,
      "Villa del Parque": 2063, "Villa Devoto": 2348, "Boedo": 1876
    };

    // Condiciones binarias (si no cumple = al fondo)
    const DEFAULT_CONDITIONS = {
      activo:        { label: 'Activo',         enabled: true, desc: 'Solo publicaciones online' },
      apto_credito:  { label: 'Apto cr√©dito',   enabled: true, desc: 'Solo las que aceptan cr√©dito' },
      ok_presupuesto:{ label: 'En presupuesto', enabled: true, desc: 'Solo las que pod√©s pagar' },
    };

    // Preferencias ponderadas (ajustan el score)
    const DEFAULT_WEIGHTS = {
      bajo_mercado:  { label: 'Bajo mercado',   weight: 7,  desc: 'Precio bajo vs promedio barrio' },
      m2:            { label: 'M¬≤ cubiertos',   weight: 5,  desc: 'M√°s m¬≤ = mejor' },
      terraza:       { label: 'Terraza',        weight: 5,  desc: 'Tiene terraza' },
      balcon:        { label: 'Balc√≥n',         weight: 3,  desc: 'Tiene balc√≥n' },
      cochera:       { label: 'Cochera',        weight: 4,  desc: 'Tiene cochera' },
      luminosidad:   { label: 'Luminoso',       weight: 4,  desc: 'Es luminoso' },
      frente:        { label: 'Al frente',      weight: 3,  desc: 'Disposici√≥n frente' },
    };

    function loadConditions() {
      try {
        const saved = localStorage.getItem('casita_conditions');
        if (saved) {
          const parsed = JSON.parse(saved);
          const conditions = JSON.parse(JSON.stringify(DEFAULT_CONDITIONS));
          Object.keys(parsed).forEach(k => {
            if (conditions[k]) conditions[k].enabled = parsed[k];
          });
          return conditions;
        }
        return JSON.parse(JSON.stringify(DEFAULT_CONDITIONS));
      } catch { return JSON.parse(JSON.stringify(DEFAULT_CONDITIONS)); }
    }

    function saveConditions(conditions) {
      const toSave = {};
      Object.keys(conditions).forEach(k => { toSave[k] = conditions[k].enabled; });
      localStorage.setItem('casita_conditions', JSON.stringify(toSave));
    }

    function loadWeights() {
      try {
        const saved = localStorage.getItem('casita_weights');
        if (saved) {
          const parsed = JSON.parse(saved);
          const weights = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
          Object.keys(parsed).forEach(k => {
            if (weights[k]) weights[k].weight = parsed[k];
          });
          return weights;
        }
        return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      } catch { return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS)); }
    }

    function saveWeights(weights) {
      const toSave = {};
      Object.keys(weights).forEach(k => { toSave[k] = weights[k].weight; });
      localStorage.setItem('casita_weights', JSON.stringify(toSave));
    }

    let CONDITIONS = loadConditions();
    let WEIGHTS = loadWeights();

    function loadConfig() {
      try {
        const saved = localStorage.getItem('casita_config');
        if (saved) {
          const parsed = JSON.parse(saved);
          // Force new auto-refresh default if user had old value
          if (parsed.AUTO_REFRESH === 60) {
            parsed.AUTO_REFRESH = DEFAULT_CONFIG.AUTO_REFRESH;
          }
          return { ...DEFAULT_CONFIG, ...parsed };
        }
        return { ...DEFAULT_CONFIG };
      } catch { return { ...DEFAULT_CONFIG }; }
    }

    function loadRefM2() {
      try {
        const saved = localStorage.getItem('casita_ref_m2');
        return saved ? JSON.parse(saved) : { ...DEFAULT_REF_M2 };
      } catch { return { ...DEFAULT_REF_M2 }; }
    }

    function saveConfig(config) {
      localStorage.setItem('casita_config', JSON.stringify(config));
    }

    function saveRefM2(refM2) {
      localStorage.setItem('casita_ref_m2', JSON.stringify(refM2));
    }

    let CONFIG = loadConfig();
    let REF_M2 = loadRefM2();

    // Calcula cr√©dito en USD seg√∫n tipo de cambio
    function getCreditoUSD(dolar = null) {
      const tc = dolar || CONFIG.DOLAR_BASE;
      return Math.round(CONFIG.CREDITO_ARS / tc);
    }

    // Calcula rango de precios de propiedades que podemos comprar
    function getPrecioRange(dolar = null) {
      const credito = getCreditoUSD(dolar);
      // Precio m√≠nimo: el banco cubre m√°ximo 90%, entonces precio_min = cr√©dito / 0.9
      const precioMin = Math.round(credito / 0.9);
      // Precio m√°ximo: cr√©dito + lo que tenemos - gastos (~10% del precio)
      // total = precio - cr√©dito + gastos ‚âà precio - cr√©dito + precio * 0.10
      // presupuesto = precio * 1.10 - cr√©dito
      // precio = (presupuesto + cr√©dito) / 1.10
      const gastosRate = CONFIG.ESCRIBANO + CONFIG.SELLOS + CONFIG.REGISTRALES + CONFIG.INMOB + CONFIG.HIPOTECA;
      const precioMax = Math.round((CONFIG.PRESUPUESTO + credito) / (1 + gastosRate));
      return { min: precioMin, max: precioMax };
    }

    // Consulta d√≥lar BNA venta desde API
    async function fetchDolarBNA() {
      try {
        // Usar Bluelytics que tiene hist√≥rico
        const response = await fetch('https://api.bluelytics.com.ar/v2/evolution.json');
        if (!response.ok) throw new Error('API error');
        const allData = await response.json();

        // Filtrar solo "Oficial" y ordenar por fecha desc
        const oficial = allData.filter(d => d.source === 'Oficial');
        if (oficial.length === 0) throw new Error('No data');

        const hoy = oficial[0];
        const hace1Dia = oficial.find((d, i) => i > 0 && d.date !== hoy.date);
        const hace7Dias = oficial.slice(0, 14).find(d => {
          const diff = (new Date(hoy.date) - new Date(d.date)) / (1000 * 60 * 60 * 24);
          return diff >= 6 && diff <= 8;
        });
        const hace30Dias = oficial.find(d => {
          const diff = (new Date(hoy.date) - new Date(d.date)) / (1000 * 60 * 60 * 24);
          return diff >= 28 && diff <= 32;
        });

        const variaciones = {
          dia: hace1Dia ? ((hoy.value_sell - hace1Dia.value_sell) / hace1Dia.value_sell * 100).toFixed(2) : null,
          semana: hace7Dias ? ((hoy.value_sell - hace7Dias.value_sell) / hace7Dias.value_sell * 100).toFixed(2) : null,
          mes: hace30Dias ? ((hoy.value_sell - hace30Dias.value_sell) / hace30Dias.value_sell * 100).toFixed(2) : null
        };

        return {
          venta: hoy.value_sell,
          compra: hoy.value_buy,
          fecha: hoy.date,
          variaciones
        };
      } catch (err) {
        console.error('Error fetching dolar:', err);
        return null;
      }
    }

    const SAMPLE_CSV = `direccion,barrio,precio,m2_cub,m2_tot,m2_terr,amb,apto_credito,terraza,expensas,inmobiliaria,status,notas,link,activo,contacto,fecha_contacto,fecha_visita,antiguedad,estado,luminosidad,rating
Av Juan B Alberdi 4600,Parque Avellaneda,105000,70,140,70,3,si,si,0,GOLDEN HAUS,Visitado,Visita 30/8. Norte/Frente. 40 a√±os.,https://www.argenprop.com/ficha--17094976,si,,,,,Bueno,Buena,`;

    let state = {
      rawData: '',
      loading: false,
      error: null,
      lastUpdate: null,
      filterStatus: 'todos',
      filterOk: 'todos',
      filterBarrio: 'todos',
      filterActivo: 'todos',
      showHelp: false,
      sortBy: 'score',
      sortDir: 'desc',
      showConfig: false,
      configTab: 'general',
      autoRefreshEnabled: CONFIG.AUTO_REFRESH > 0,
      selectedProperty: null,
      viewMode: 'auto',
      negotiationPct: 0,
      dolarEstimado: null,  // null = usar DOLAR_BASE
      dolarBNA: null,       // √∫ltimo valor consultado del BNA
      loadingDolar: false
    };

    let autoRefreshInterval = null;

    function startAutoRefresh() {
      stopAutoRefresh();
      if (CONFIG.AUTO_REFRESH > 0) {
        state.autoRefreshEnabled = true;
        console.log(`‚è±Ô∏è Auto-refresh cada ${CONFIG.AUTO_REFRESH}s`);
        autoRefreshInterval = setInterval(() => {
          fetchData();
        }, CONFIG.AUTO_REFRESH * 1000);
      }
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
      state.autoRefreshEnabled = false;
    }

    function toggleAutoRefresh() {
      if (state.autoRefreshEnabled) {
        stopAutoRefresh();
      } else {
        startAutoRefresh();
      }
      render();
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, '_'));
      return lines.slice(1).map((line, idx) => {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (const char of line) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());
        const obj = { _idx: idx };
        headers.forEach((h, i) => { obj[h] = values[i] || ''; });
        return obj;
      }).filter(row => {
        // Filter out empty rows - must have at least direccion OR barrio OR link
        return row.direccion || row.barrio || row.link;
      });
    }

    function calculateProperty(p) {
      const precio = parseFloat(p.precio) || 0;
      const m2 = parseFloat(p.m2_cub) || 0;
      const barrio = p.barrio;
      const tieneInmob = p.inmobiliaria && p.inmobiliaria.trim() !== '';
      const creditoUSD = getCreditoUSD();
      const calc = { ...p, _precio: precio, _m2: m2, _preciom2: m2 > 0 ? Math.round(precio / m2) : 0, _ref: REF_M2[barrio] || 0 };
      calc._vsRef = (calc._preciom2 > 0 && calc._ref > 0) ? (calc._preciom2 - calc._ref) / calc._ref : null;
      calc._tu10 = Math.max(precio - creditoUSD, precio * 0.1);
      calc._escr = Math.round(precio * CONFIG.ESCRIBANO);
      calc._sell = precio <= CONFIG.SELLOS_EXENTO ? 0 : Math.round(precio * CONFIG.SELLOS);
      calc._reg = Math.round(precio * CONFIG.REGISTRALES);
      calc._inmob = tieneInmob ? Math.round(precio * CONFIG.INMOB) : 0;
      calc._hip = Math.round(precio * CONFIG.HIPOTECA);
      calc._cert = CONFIG.CERTIFICADOS;
      calc._total = calc._tu10 + calc._escr + calc._sell + calc._reg + calc._inmob + calc._hip + calc._cert;
      calc._ok = calc._total <= CONFIG.PRESUPUESTO;
      calc._dif = CONFIG.PRESUPUESTO - calc._total;
      calc._completeness = [p.direccion, p.barrio, precio > 0, m2 > 0].filter(Boolean).length;

      // Score de candidato (sistema de tiers + preferencias)
      let score = 0;
      const activo = (p.activo || '').toLowerCase();
      const aptoCredito = (p.apto_credito || '').toLowerCase();
      const W = WEIGHTS;  // Preferencias ponderadas

      // === SISTEMA DE TIERS (capas jer√°rquicas) ===
      // Cada tier separa por 10000 pts para que las preferencias no mezclen tiers
      const TIER_GAP = 10000;

      if (!p.link) {
        // Sin link = tier m√°s bajo
        score = -5 * TIER_GAP;
      } else if (activo === 'no') {
        // TIER 4: Inactivo (abajo de todo)
        score = -4 * TIER_GAP;
      } else if (aptoCredito === 'no') {
        // TIER 3: Activo pero NO apto cr√©dito
        score = -3 * TIER_GAP;
      } else if (!calc._ok && precio > 0) {
        // TIER 2: Activo + Apto cr√©dito pero NO en presupuesto
        score = -2 * TIER_GAP;
      } else {
        // TIER 1: Activo + Apto cr√©dito + En presupuesto (los mejores)
        score = 0;
      }

      // === PREFERENCIAS PONDERADAS (dentro de cada tier) ===
      // Valor vs mercado
      if (calc._vsRef !== null && W.bajo_mercado.weight > 0) {
        if (calc._vsRef < -0.15) score += 15 * W.bajo_mercado.weight;
        else if (calc._vsRef < -0.05) score += 8 * W.bajo_mercado.weight;
        else if (calc._vsRef < 0) score += 3 * W.bajo_mercado.weight;
        else if (calc._vsRef > 0.15) score -= 5 * W.bajo_mercado.weight;
      }

      // M¬≤ (m√°s es mejor)
      if (W.m2.weight > 0) {
        if (m2 >= 70) score += 4 * W.m2.weight;
        else if (m2 >= 50) score += 2 * W.m2.weight;
        else if (m2 >= 40) score += 1 * W.m2.weight;
      }

      // Caracter√≠sticas
      if (p.terraza?.toLowerCase() === 'si') score += 10 * W.terraza.weight;
      if (p.balcon?.toLowerCase() === 'si') score += 10 * W.balcon.weight;
      if (parseInt(p.cocheras) > 0) score += 10 * W.cochera.weight;
      if (p.luminosidad?.toLowerCase() === 'si') score += 10 * W.luminosidad.weight;
      if (p.disposicion?.toLowerCase() === 'frente') score += 10 * W.frente.weight;

      // Datos completos (menor peso)
      score += calc._completeness * 3;

      calc._score = score;
      return calc;
    }

    const API_KEY = 'AIzaSyClZvK5NbmLEtxi9tqf1fcKxRIKEUqYnu0';
    const SHEET_ID = '16n92ghEe8Vr1tiLdqbccF3i97kiwhHin9OPWY-O50L4';

    async function fetchData() {
      console.group('üîÑ fetchData()');
      console.log('Timestamp:', new Date().toISOString());

      state.loading = true;
      state.error = null;
      render();

      const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:AH?key=${API_KEY}`;
      console.log('Using Sheets API');

      try {
        console.log('Fetching...');
        const response = await fetch(API_URL);

        console.log('Response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('Rows received:', data.values?.length || 0);

        if (!data.values || data.values.length < 2) {
          throw new Error('No hay datos');
        }

        // Convert API response to CSV format for compatibility
        const csvLines = data.values.map(row =>
          row.map(cell => {
            const val = (cell || '').toString();
            // Escape quotes and wrap in quotes if contains comma
            if (val.includes(',') || val.includes('"')) {
              return '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
          }).join(',')
        );
        const csvText = csvLines.join('\n');

        const headers = data.values[0];
        const validRows = data.values.slice(1).filter(row => row[0] || row[1] || row[2]);

        console.log('Valid rows:', validRows.length);
        const direcciones = validRows.map(row => row[0] || '(vac√≠o)');
        console.log('Direcciones:', direcciones.join(' | '));

        state.rawData = csvText;
        state.lastUpdate = new Date();
        state.error = null;

        console.log('‚úÖ Data loaded successfully via API');

      } catch (err) {
        console.error('‚ùå Error:', err.message);
        state.error = 'Error: ' + err.message;
        if (!state.rawData) state.rawData = SAMPLE_CSV;
      }

      state.loading = false;
      console.groupEnd();
      render();
    }

    function getProperties() {
      return parseCSV(state.rawData).map(calculateProperty);
    }

    function getFiltered(properties) {
      let result = [...properties];
      if (state.filterStatus !== 'todos') result = result.filter(p => p.status?.toLowerCase().includes(state.filterStatus.toLowerCase()));
      if (state.filterOk === 'ok') result = result.filter(p => p._ok);
      else if (state.filterOk === 'no') result = result.filter(p => !p._ok);
      if (state.filterBarrio !== 'todos') result = result.filter(p => p.barrio === state.filterBarrio);
      if (state.filterActivo === 'si') result = result.filter(p => p.activo?.toLowerCase() === 'si');
      else if (state.filterActivo === 'no') result = result.filter(p => p.activo?.toLowerCase() === 'no');
      result.sort((a, b) => {
        let va = a['_' + state.sortBy] ?? a[state.sortBy] ?? 0;
        let vb = b['_' + state.sortBy] ?? b[state.sortBy] ?? 0;
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        return state.sortDir === 'asc' ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
      return result;
    }

    function getStats(properties) {
      return {
        total: properties.length,
        entran: properties.filter(p => p._ok).length,
        activos: properties.filter(p => p.activo?.toLowerCase() === 'si').length,
        porVer: properties.filter(p => p.status?.toLowerCase().includes('por ver')).length,
        minPrecio: properties.filter(p => p._precio > 0).length > 0 ? Math.min(...properties.filter(p => p._precio > 0).map(p => p._precio)) : 0,
        maxPrecio: properties.filter(p => p._precio > 0).length > 0 ? Math.max(...properties.filter(p => p._precio > 0).map(p => p._precio)) : 0,
      };
    }

    function evalIcon(vsRef) {
      if (vsRef === null || vsRef === undefined) return '<span class="text-slate-300 text-xs italic">s/d</span>';
      const pct = Math.round(vsRef * 100);
      const sign = pct > 0 ? '+' : '';
      if (vsRef < -CONFIG.MARGEN_REF) return `<span class="text-green-600 text-xs font-medium" title="Bajo mercado">${sign}${pct}%</span>`;
      if (vsRef > CONFIG.MARGEN_REF) return `<span class="text-red-500 text-xs font-medium" title="Sobre mercado">${sign}${pct}%</span>`;
      return `<span class="text-yellow-600 text-xs" title="En mercado">${sign}${pct}%</span>`;
    }

    function okPill(ok) {
      return ok
        ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚úì</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">‚úó</span>';
    }

    function activoBadge(activo) {
      if (!activo) return '<span class="text-slate-300">?</span>';
      const s = activo.toLowerCase();
      if (s === 'si') return '<span class="text-green-600 text-lg">‚úì</span>';
      if (s === 'no') return '<span class="text-red-600 text-lg">‚úó</span>';
      return `<span class="text-yellow-600">${activo}</span>`;
    }

    function aptoCreditoBadge(apto) {
      if (!apto) return '<span class="text-slate-300">?</span>';
      const s = apto.toLowerCase();
      if (s === 'si') return '<span class="text-green-600 text-lg">‚úì</span>';
      if (s === 'no') return '<span class="text-amber-600 text-lg">‚úó</span>';
      return `<span class="text-yellow-600">${apto}</span>`;
    }

    function statusBadge(status) {
      if (!status) return '<span class="text-slate-300 text-xs italic">status?</span>';
      const s = status.toLowerCase();
      if (s.includes('visitado')) return `<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">${status}</span>`;
      if (s.includes('interesado')) return `<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">${status}</span>`;
      if (s.includes('descartado')) return `<span class="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded">${status}</span>`;
      return `<span class="text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">${status}</span>`;
    }

    function ratingStars(rating) {
      if (!rating) return '-';
      const n = parseInt(rating) || 0;
      return '‚òÖ'.repeat(n) + '‚òÜ'.repeat(5 - n);
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function showDetail(idx) {
      state.selectedProperty = idx;
      state.negotiationPct = 0;
      state.dolarEstimado = null;
      render();
    }

    function closeDetail() {
      state.selectedProperty = null;
      state.negotiationPct = 0;
      state.dolarEstimado = null;
      render();
    }

    function updateNegotiation(pct) {
      state.negotiationPct = parseFloat(pct);
      render();
    }

    function updateDolarEstimado(valor) {
      state.dolarEstimado = valor ? parseInt(valor) : null;
      render();
    }

    async function cargarDolarHoy() {
      state.loadingDolar = true;
      render();
      const data = await fetchDolarBNA();
      state.loadingDolar = false;
      if (data) {
        state.dolarBNA = data;
        state.dolarEstimado = Math.round(data.venta);
      }
      render();
    }

    function updateConfig(key, value) {
      CONFIG[key] = value;
      saveConfig(CONFIG);
      render();
    }

    function updateRefM2(barrio, value) {
      if (value === '' || value === null) {
        delete REF_M2[barrio];
      } else {
        REF_M2[barrio] = parseInt(value) || 0;
      }
      saveRefM2(REF_M2);
      render();
    }

    function updateWeight(key, value) {
      WEIGHTS[key].weight = parseInt(value);
      saveWeights(WEIGHTS);
      render();
    }

    function toggleCondition(key, enabled) {
      CONDITIONS[key].enabled = enabled;
      saveConditions(CONDITIONS);
      render();
    }

    function resetWeights() {
      if (confirm('¬øResetear condiciones y preferencias a valores por defecto?')) {
        CONDITIONS = JSON.parse(JSON.stringify(DEFAULT_CONDITIONS));
        WEIGHTS = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
        saveConditions(CONDITIONS);
        saveWeights(WEIGHTS);
        render();
      }
    }

    function addBarrio() {
      const nombre = prompt('Nombre del barrio:');
      if (nombre && nombre.trim()) {
        const valor = prompt('$/m¬≤ de referencia:');
        if (valor) {
          REF_M2[nombre.trim()] = parseInt(valor) || 0;
          saveRefM2(REF_M2);
          render();
        }
      }
    }

    function deleteBarrio(barrio) {
      if (confirm(`¬øEliminar ${barrio}?`)) {
        delete REF_M2[barrio];
        saveRefM2(REF_M2);
        render();
      }
    }

    function resetConfig() {
      if (confirm('¬øResetear toda la configuraci√≥n a los valores por defecto?')) {
        CONFIG = { ...DEFAULT_CONFIG };
        REF_M2 = { ...DEFAULT_REF_M2 };
        CONDITIONS = JSON.parse(JSON.stringify(DEFAULT_CONDITIONS));
        WEIGHTS = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
        saveConfig(CONFIG);
        saveRefM2(REF_M2);
        saveConditions(CONDITIONS);
        saveWeights(WEIGHTS);
        state.manualUrl = CONFIG.SHEET_URL;
        render();
      }
    }

    function renderDetailModal(p) {
      if (!p) return '';

      // Cr√©dito base y con d√≥lar estimado
      const dolarActual = state.dolarEstimado || CONFIG.DOLAR_BASE;
      const creditoBase = getCreditoUSD();
      const creditoEstimado = getCreditoUSD(dolarActual);
      const diferenciaCredito = creditoBase - creditoEstimado;

      // Calcular valores con negociaci√≥n Y d√≥lar estimado
      const negPct = state.negotiationPct / 100;
      const precioNeg = Math.round(p._precio * (1 - negPct));
      const tu10Neg = Math.max(precioNeg - creditoEstimado, precioNeg * 0.1);
      const escrNeg = Math.round(precioNeg * CONFIG.ESCRIBANO);
      const sellNeg = precioNeg <= CONFIG.SELLOS_EXENTO ? 0 : Math.round(precioNeg * CONFIG.SELLOS);
      const regNeg = Math.round(precioNeg * CONFIG.REGISTRALES);
      const inmobNeg = p.inmobiliaria ? Math.round(precioNeg * CONFIG.INMOB) : 0;
      const hipNeg = Math.round(precioNeg * CONFIG.HIPOTECA);
      const totalNeg = tu10Neg + escrNeg + sellNeg + regNeg + inmobNeg + hipNeg + CONFIG.CERTIFICADOS;
      const okNeg = totalNeg <= CONFIG.PRESUPUESTO;
      const difNeg = CONFIG.PRESUPUESTO - totalNeg;
      const ahorro = p._total - totalNeg;

      // ¬øHay alg√∫n ajuste activo (negociaci√≥n o d√≥lar)?
      const hayAjuste = state.negotiationPct > 0 || (state.dolarEstimado && state.dolarEstimado !== CONFIG.DOLAR_BASE);
      const hayAjusteDolar = state.dolarEstimado && state.dolarEstimado !== CONFIG.DOLAR_BASE;

      return `
        <div class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onclick="if(event.target===this)closeDetail()">
          <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-start">
              <div>
                <h2 class="text-xl font-bold text-slate-800">${escapeHtml(p.direccion) || '<span class="text-slate-400">Sin direcci√≥n</span>'}</h2>
                <p class="text-slate-500">${escapeHtml(p.barrio) || 'Sin barrio'}</p>
              </div>
              <button onclick="closeDetail()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div class="p-6 space-y-6">
              <!-- Status y Link -->
              <div class="flex flex-wrap gap-2 items-center">
                ${statusBadge(p.status)}
                ${activoBadge(p.activo)}
                ${p.apto_credito?.toLowerCase() === 'si' ? '<span class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">Apto cr√©dito</span>' : ''}
                ${p.link ? `<a href="${escapeHtml(p.link)}" target="_blank" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded hover:bg-blue-200">Ver aviso ‚Üó</a>` : ''}
              </div>

              <!-- Slider de negociaci√≥n -->
              ${p._precio > 0 ? `
              <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-4 border border-orange-200">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-orange-800">ü§ù Negociar precio</span>
                  <span class="text-lg font-bold ${state.negotiationPct > 0 ? 'text-orange-600' : 'text-slate-400'}">${state.negotiationPct > 0 ? '-' + (state.negotiationPct % 1 === 0 ? state.negotiationPct : state.negotiationPct.toFixed(1)) + '%' : 'Sin descuento'}</span>
                </div>
                <input type="range" min="0" max="12" step="0.5" value="${state.negotiationPct}"
                  onchange="updateNegotiation(this.value)"
                  oninput="updateNegotiation(this.value)"
                  class="w-full h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-500" />
                <div class="flex justify-between text-xs text-orange-600 mt-1">
                  <span>Publicado</span>
                  <span>-12%</span>
                </div>
                ${state.negotiationPct > 0 ? `
                <div class="mt-3 pt-3 border-t border-orange-200 grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-orange-600">Precio original:</span>
                    <span class="line-through text-slate-400 ml-1">$${p._precio.toLocaleString()}</span>
                  </div>
                  <div>
                    <span class="text-orange-600">Precio negociado:</span>
                    <span class="font-bold text-orange-700 ml-1">$${precioNeg.toLocaleString()}</span>
                  </div>
                </div>
                ` : ''}
              </div>
              ` : ''}

              <!-- Simulador d√≥lar -->
              <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-3 border border-emerald-200">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-xs text-emerald-700">üìà D√≥lar estimado</span>
                  <input type="range" min="1000" max="2500" step="50" value="${dolarActual}"
                    onchange="updateDolarEstimado(this.value)"
                    oninput="updateDolarEstimado(this.value)"
                    class="flex-1 h-1.5 bg-emerald-200 rounded-lg appearance-none cursor-pointer accent-emerald-500" />
                  <span class="text-sm font-bold ${hayAjusteDolar ? 'text-emerald-600' : 'text-slate-500'}">$${dolarActual.toLocaleString()}</span>
                  ${state.dolarBNA ? `<button onclick="state.dolarEstimado=${state.dolarBNA.venta};render()" class="text-xs px-1.5 py-0.5 bg-emerald-600 text-white rounded hover:bg-emerald-700">Hoy</button>` : ''}
                  ${hayAjusteDolar ? `<button onclick="updateDolarEstimado(null)" class="text-xs text-emerald-600">‚úï</button>` : ''}
                </div>
                <div class="flex items-center justify-between text-xs">
                  <span class="text-emerald-600">Cr√©dito: $${(CONFIG.CREDITO_ARS/1000000).toFixed(0)}M ‚Üí <strong class="${diferenciaCredito > 0 ? 'text-red-600' : diferenciaCredito < 0 ? 'text-green-600' : 'text-slate-700'}">$${creditoEstimado.toLocaleString()} USD</strong></span>
                  ${diferenciaCredito !== 0 ? `
                    <span class="${diferenciaCredito > 0 ? 'text-red-600' : 'text-green-600'}">
                      ${diferenciaCredito > 0 ? '‚ö†Ô∏è -' : '‚ú® +'}$${Math.abs(diferenciaCredito).toLocaleString()}
                    </span>
                  ` : ''}
                </div>
                ${hayAjusteDolar && p._precio > 0 ? `
                <div class="flex items-center justify-between text-xs mt-1 pt-1 border-t border-emerald-200">
                  <span class="text-emerald-600">A juntar: <span class="line-through text-emerald-400">$${p._total.toLocaleString()}</span> ‚Üí <strong class="${okNeg ? 'text-green-600' : 'text-red-600'}">$${totalNeg.toLocaleString()}</strong></span>
                  <span class="${ahorro < 0 ? 'text-red-600' : 'text-green-600'}">
                    ${ahorro < 0 ? '‚ö†Ô∏è +' : '‚ú® -'}$${Math.abs(ahorro).toLocaleString()}
                  </span>
                </div>
                ` : ''}
              </div>

              <!-- N√∫meros principales -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-50 rounded-xl p-3 text-center">
                  ${state.negotiationPct > 0 && p._precio > 0 ? `
                    <div class="text-sm line-through text-slate-400">$${p._precio.toLocaleString()}</div>
                    <div class="text-2xl font-bold text-orange-600">$${precioNeg.toLocaleString()}</div>
                  ` : `
                    <div class="text-2xl font-bold text-slate-800">$${p._precio > 0 ? p._precio.toLocaleString() : '-'}</div>
                  `}
                  <div class="text-xs text-slate-500">Precio</div>
                </div>
                <div class="bg-slate-50 rounded-xl p-3 text-center">
                  <div class="text-2xl font-bold text-slate-800">${p._m2 || '-'}</div>
                  <div class="text-xs text-slate-500">m¬≤ cub</div>
                </div>
                <div class="bg-slate-50 rounded-xl p-3 text-center">
                  <div class="text-2xl font-bold text-slate-800">${p._preciom2 > 0 ? '$' + p._preciom2.toLocaleString() : '-'}</div>
                  <div class="text-xs text-slate-500">$/m¬≤ ${p._ref ? `(ref: ${p._ref})` : ''}</div>
                </div>
                <div class="bg-slate-50 rounded-xl p-3 text-center">
                  ${hayAjuste && p._precio > 0 ? `
                    <div class="text-sm line-through text-slate-400">$${p._total.toLocaleString()}</div>
                    <div class="text-2xl font-bold ${okNeg ? 'text-green-600' : 'text-red-600'}">$${totalNeg.toLocaleString()}</div>
                  ` : `
                    <div class="text-2xl font-bold ${p._ok ? 'text-green-600' : 'text-red-600'}">$${p._total.toLocaleString()}</div>
                  `}
                  <div class="text-xs text-slate-500">A juntar ${(hayAjuste ? okNeg : p._ok) ? '‚úì' : '‚úó'}</div>
                </div>
              </div>

              <!-- Caracter√≠sticas -->
              <div>
                <h3 class="text-sm font-medium text-slate-700 mb-3 pb-1 border-b border-slate-100">Caracter√≠sticas</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-2 text-sm">
                  <div class="flex justify-between"><span class="text-slate-400">Tipo</span><span class="text-slate-700 font-medium">${p.tipo ? p.tipo.toUpperCase() : '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Ambientes</span><span class="text-slate-700">${p.amb || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">m¬≤ cubiertos</span><span class="text-slate-700">${p.m2_cub || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">m¬≤ total</span><span class="text-slate-700">${p.m2_tot || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Piso</span><span class="text-slate-700">${p.piso !== undefined && p.piso !== '' ? (p.piso === '0' ? 'PB' : p.piso + '¬∞') : '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Disposici√≥n</span><span class="text-slate-700">${p.disposicion || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Antig√ºedad</span><span class="text-slate-700">${p.antiguedad ? p.antiguedad + ' a√±os' : '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Estado</span><span class="text-slate-700">${p.estado || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Expensas</span><span class="text-slate-700">${p.expensas ? '$' + parseInt(p.expensas).toLocaleString() : '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Cocheras</span><span class="text-slate-700">${p.cocheras || '0'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Terraza</span><span class="${p.terraza?.toLowerCase() === 'si' ? 'text-green-600' : 'text-slate-700'}">${p.terraza || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Balc√≥n</span><span class="${p.balcon?.toLowerCase() === 'si' ? 'text-green-600' : 'text-slate-700'}">${p.balcon || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Ascensor</span><span class="${p.ascensor?.toLowerCase() === 'si' ? 'text-green-600' : p.ascensor?.toLowerCase() === 'no' ? 'text-red-500' : 'text-slate-700'}">${p.ascensor || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Luminosidad</span><span class="${p.luminosidad?.toLowerCase() === 'si' ? 'text-green-600' : 'text-slate-700'}">${p.luminosidad || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">m¬≤ terraza</span><span class="text-slate-700">${p.m2_terr || '-'}</span></div>
                </div>
              </div>

              <!-- Lo que necesit√°s poner -->
              <div>
                <h3 class="text-sm font-medium text-slate-700 mb-3 pb-1 border-b border-slate-100">
                  Lo que necesit√°s poner
                  ${state.negotiationPct > 0 ? `<span class="text-orange-500 text-xs ml-2">(-${state.negotiationPct % 1 === 0 ? state.negotiationPct : state.negotiationPct.toFixed(1)}%)</span>` : ''}
                  ${hayAjusteDolar ? `<span class="text-emerald-500 text-xs ml-1">(@$${dolarActual.toLocaleString()})</span>` : ''}
                </h3>
                <div class="bg-slate-50 rounded-xl p-4 text-sm">
                  <!-- Tu aporte -->
                  <div class="flex justify-between py-2 mb-2 bg-blue-50 rounded-lg px-3">
                    <span class="text-blue-700 font-medium">Tu aporte (10% o m√°s)</span>
                    <span class="font-mono font-bold text-blue-700">
                      ${hayAjuste ? `<span class="line-through text-blue-300 text-sm mr-1">$${p._tu10.toLocaleString()}</span>` : ''}
                      $${(hayAjuste ? tu10Neg : p._tu10).toLocaleString()}
                    </span>
                  </div>

                  <!-- Gastos de escrituraci√≥n -->
                  <div class="text-xs text-slate-400 uppercase tracking-wide mb-2 mt-3">Gastos de escrituraci√≥n</div>
                  <div class="grid grid-cols-2 gap-x-8 gap-y-1">
                    <div class="flex justify-between py-1 border-b border-slate-100"><span class="text-slate-500">Escribano</span><span class="font-mono text-slate-700">$${(hayAjuste ? escrNeg : p._escr).toLocaleString()}</span></div>
                    <div class="flex justify-between py-1 border-b border-slate-100"><span class="text-slate-500">Sellos</span><span class="font-mono text-slate-700">$${(hayAjuste ? sellNeg : p._sell).toLocaleString()}</span></div>
                    <div class="flex justify-between py-1 border-b border-slate-100"><span class="text-slate-500">Registrales</span><span class="font-mono text-slate-700">$${(hayAjuste ? regNeg : p._reg).toLocaleString()}</span></div>
                    <div class="flex justify-between py-1 border-b border-slate-100"><span class="text-slate-500">Hipoteca</span><span class="font-mono text-slate-700">$${(hayAjuste ? hipNeg : p._hip).toLocaleString()}</span></div>
                    <div class="flex justify-between py-1 border-b border-slate-100"><span class="text-slate-500">Certificados</span><span class="font-mono text-slate-700">$${p._cert.toLocaleString()}</span></div>
                    <div class="flex justify-between py-1"><span class="text-slate-500">Inmobiliaria</span><span class="font-mono text-slate-700">$${(hayAjuste ? inmobNeg : p._inmob).toLocaleString()}</span></div>
                  </div>

                  <!-- Total -->
                  <div class="flex justify-between mt-4 pt-3 border-t-2 border-slate-300 font-bold text-lg ${(hayAjuste ? okNeg : p._ok) ? 'text-green-600' : 'text-red-600'}">
                    <span>TOTAL A JUNTAR</span>
                    <span class="font-mono">
                      ${hayAjuste ? `<span class="line-through text-slate-400 text-sm mr-1">$${p._total.toLocaleString()}</span>` : ''}
                      $${(hayAjuste ? totalNeg : p._total).toLocaleString()}
                    </span>
                  </div>
                  ${hayAjuste && ahorro > 0 ? `
                  <div class="mt-2 text-center text-xs text-orange-600 bg-orange-50 rounded py-1">
                    Ahorr√°s $${ahorro.toLocaleString()} vs escenario base
                  </div>
                  ` : ''}
                  ${hayAjuste && ahorro < 0 ? `
                  <div class="mt-2 text-center text-xs text-red-600 bg-red-50 rounded py-1">
                    Necesit√°s $${Math.abs(ahorro).toLocaleString()} m√°s vs escenario base
                  </div>
                  ` : ''}
                  <div class="mt-3 text-center text-sm font-medium ${(hayAjuste ? difNeg : p._dif) >= 0 ? 'text-green-600 bg-green-50' : 'text-red-500 bg-red-50'} rounded-lg py-2">
                    ${(hayAjuste ? difNeg : p._dif) >= 0
                      ? `Te sobran $${(hayAjuste ? difNeg : p._dif).toLocaleString()}`
                      : `Te faltan $${Math.abs(hayAjuste ? difNeg : p._dif).toLocaleString()}`}
                  </div>
                </div>
              </div>

              <!-- Gesti√≥n -->
              <div>
                <h3 class="text-sm font-medium text-slate-700 mb-3 pb-1 border-b border-slate-100">Gesti√≥n</h3>
                <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                  <div class="flex justify-between"><span class="text-slate-400">Inmobiliaria</span><span class="text-slate-700">${p.inmobiliaria || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Contacto</span><span class="text-slate-700">${p.contacto || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Fecha contacto</span><span class="text-slate-700">${p.fecha_contacto || '-'}</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">Fecha visita</span><span class="text-slate-700">${p.fecha_visita || '-'}</span></div>
                </div>
              </div>

              <!-- Rating -->
              ${p.rating ? `
              <div>
                <h3 class="text-sm font-medium text-slate-700 mb-3 pb-1 border-b border-slate-100">Rating</h3>
                <div class="text-2xl text-yellow-500">${ratingStars(p.rating)}</div>
              </div>
              ` : ''}

              <!-- Notas -->
              ${p.notas ? `
              <div>
                <h3 class="text-sm font-medium text-slate-700 mb-3 pb-1 border-b border-slate-100">Notas</h3>
                <p class="text-sm text-slate-600 bg-slate-50 rounded-xl p-4 leading-relaxed">${escapeHtml(p.notas)}</p>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderCards(filtered) {
      return `
        <div class="space-y-3">
          ${filtered.map(p => {
            const completePct = p._completeness * 25;
            const barColor = p._completeness >= 3 ? 'bg-green-500' : p._completeness >= 2 ? 'bg-yellow-500' : 'bg-red-400';
            const isInactivo = (p.activo || '').toLowerCase() === 'no';
            const noAptoCredito = (p.apto_credito || '').toLowerCase() !== 'si';
            const cardStyle = isInactivo
              ? 'bg-red-50 border-2 border-red-200 opacity-70'
              : noAptoCredito
                ? 'bg-amber-50 border-2 border-amber-200 opacity-80'
                : 'bg-white';
            const warnings = [];
            if (isInactivo) warnings.push('<span class="text-red-600">INACTIVO</span>');
            if (noAptoCredito) warnings.push('<span class="text-amber-600">NO APTO CR√âDITO</span>');
            return `
              <div class="${cardStyle} rounded-xl p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="showDetail(${p._idx})">
                ${warnings.length ? '<div class="text-xs font-medium mb-1">' + warnings.join(' ¬∑ ') + '</div>' : ''}
                <!-- Barra completitud -->
                <div class="flex items-center gap-2 mb-2">
                  <div class="flex-1 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-full ${barColor} rounded-full transition-all" style="width: ${completePct}%"></div>
                  </div>
                  <span class="text-xs text-slate-400">${p._completeness}/4</span>
                </div>

                <!-- Direcci√≥n + OK -->
                <div class="flex items-start justify-between gap-2 mb-1">
                  <span class="font-medium text-slate-800">${p.direccion ? escapeHtml(p.direccion) : '<span class="text-slate-300 italic">sin direcci√≥n</span>'}</span>
                  ${p._precio > 0 ? okPill(p._ok) : ''}
                </div>

                <!-- Barrio -->
                <div class="text-sm text-slate-500 mb-2">${p.barrio ? escapeHtml(p.barrio) : '<span class="text-slate-300 italic">sin barrio</span>'}</div>

                <!-- Precio, m¬≤, $/m¬≤ -->
                <div class="flex items-center gap-2 text-sm mb-2">
                  <span class="font-mono font-medium">${p._precio > 0 ? '$' + p._precio.toLocaleString() : '<span class="text-slate-300">$?</span>'}</span>
                  <span class="text-slate-300">¬∑</span>
                  <span>${p._m2 ? p._m2 + 'm¬≤' : '<span class="text-slate-300">m¬≤?</span>'}</span>
                  ${p._preciom2 > 0 ? `<span class="text-slate-300">¬∑</span><span class="text-slate-500">$${p._preciom2.toLocaleString()}/m¬≤</span>` : ''}
                </div>

                <!-- Status, Activo, vs Barrio -->
                <div class="flex flex-wrap items-center gap-2">
                  ${statusBadge(p.status)}
                  ${activoBadge(p.activo)}
                  ${evalIcon(p._vsRef)}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderHelpPanel() {
      const sheetUrl = 'https://docs.google.com/spreadsheets/d/16n92ghEe8Vr1tiLdqbccF3i97kiwhHin9OPWY-O50L4';
      return `
        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-medium text-purple-700">‚ùì C√≥mo usar</h3>
            <button onclick="state.showHelp=false;render()" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
          </div>

          <div class="space-y-4 text-sm text-slate-600">
            <div class="bg-purple-50 rounded-lg p-3">
              <p class="font-medium text-purple-800 mb-2">Agregar propiedades</p>
              <a href="${sheetUrl}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                Abrir Google Sheet
                <span>‚Üó</span>
              </a>
            </div>

            <div>
              <p class="font-medium text-slate-700 mb-2">Campos con desplegable:</p>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                <div><span class="font-mono bg-slate-100 px-1 rounded">barrio</span> - seleccionar de lista</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">amb</span> - 1 a 5</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">apto_credito</span> - si/no</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">terraza</span> - si/no</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">status</span> - Por ver, Visitado, etc.</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">activo</span> - si/no (aviso online)</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">estado</span> - Estrenar, Bueno, etc.</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">luminosidad</span> - Excelente a Poca</div>
                <div><span class="font-mono bg-slate-100 px-1 rounded">rating</span> - 1 a 5 estrellas</div>
              </div>
            </div>

            <div>
              <p class="font-medium text-slate-700 mb-2">Campos importantes:</p>
              <ul class="list-disc list-inside space-y-1 text-xs">
                <li><span class="font-mono bg-slate-100 px-1 rounded">direccion</span> - Calle y altura (ej: "Av. Rivadavia 5000")</li>
                <li><span class="font-mono bg-slate-100 px-1 rounded">precio</span> - En USD, solo el numero (ej: 95000)</li>
                <li><span class="font-mono bg-slate-100 px-1 rounded">m2_cub</span> - Metros cubiertos, para calcular $/m2</li>
                <li><span class="font-mono bg-slate-100 px-1 rounded">expensas</span> - En pesos, 0 si no tiene</li>
                <li><span class="font-mono bg-slate-100 px-1 rounded">inmobiliaria</span> - Si tiene, se suma comisi√≥n al total</li>
                <li><span class="font-mono bg-slate-100 px-1 rounded">link</span> - URL del aviso</li>
                <li><span class="font-mono bg-slate-100 px-1 rounded">notas</span> - Cualquier comentario</li>
              </ul>
            </div>

            <div class="bg-blue-50 rounded-lg p-3">
              <p class="font-medium text-blue-800 mb-1">Indicadores de precio:</p>
              <div class="flex gap-4 text-xs">
                <span>üü¢ Bajo mercado (&lt;-12%)</span>
                <span>üü° En mercado</span>
                <span>üî¥ Sobre mercado (&gt;+12%)</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderConfigPanel() {
      const tabClass = (tab) => state.configTab === tab
        ? 'px-3 py-1.5 text-sm font-medium text-blue-600 border-b-2 border-blue-600'
        : 'px-3 py-1.5 text-sm text-slate-500 hover:text-slate-700 cursor-pointer';

      return `
        <div>
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-4">
              <h3 class="font-medium text-slate-700">‚öôÔ∏è Configuraci√≥n</h3>
              <div class="flex border-b border-slate-200">
                <button onclick="state.configTab='general';render()" class="${tabClass('general')}">General</button>
                <button onclick="state.configTab='gastos';render()" class="${tabClass('gastos')}">Escrituraci√≥n</button>
                <button onclick="state.configTab='barrios';render()" class="${tabClass('barrios')}">Barrios $/m¬≤</button>
                <button onclick="state.configTab='pesos';render()" class="${tabClass('pesos')}">‚öñÔ∏è Pesos</button>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button onclick="resetConfig()" class="text-xs text-slate-400 hover:text-red-500">Reset todo</button>
              <button onclick="state.showConfig=false;render()" class="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded" title="Cerrar">‚úï</button>
            </div>
          </div>

          ${state.configTab === 'general' ? `
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-slate-500 mb-1">Cr√©dito hipotecario (ARS)</label>
                <input type="number" value="${CONFIG.CREDITO_ARS}" onchange="updateConfig('CREDITO_ARS', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">D√≥lar base (ARS/USD)</label>
                <input type="number" value="${CONFIG.DOLAR_BASE}" onchange="updateConfig('DOLAR_BASE', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">= Cr√©dito en USD</label>
                <div class="px-3 py-2 bg-slate-100 rounded-lg text-sm font-mono font-bold text-green-700">$${getCreditoUSD().toLocaleString()}</div>
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Tengo para poner (USD)</label>
                <input type="number" value="${CONFIG.PRESUPUESTO}" onchange="updateConfig('PRESUPUESTO', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">= Rango de precios</label>
                <div class="px-3 py-2 bg-slate-100 rounded-lg text-sm font-mono text-slate-700">$${getPrecioRange().min.toLocaleString()} - $${getPrecioRange().max.toLocaleString()}</div>
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Auto-refresh (seg, 0=off)</label>
                <input type="number" value="${CONFIG.AUTO_REFRESH}" onchange="updateConfig('AUTO_REFRESH', parseInt(this.value)); startAutoRefresh();" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
            </div>
          ` : ''}

          ${state.configTab === 'gastos' ? `
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-slate-500 mb-1">Escribano (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.ESCRIBANO * 100).toFixed(2)}" onchange="updateConfig('ESCRIBANO', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Sellos (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.SELLOS * 100).toFixed(2)}" onchange="updateConfig('SELLOS', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Exento sellos hasta (USD)</label>
                <input type="number" value="${CONFIG.SELLOS_EXENTO}" onchange="updateConfig('SELLOS_EXENTO', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Registrales (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.REGISTRALES * 100).toFixed(2)}" onchange="updateConfig('REGISTRALES', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Inmobiliaria (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.INMOB * 100).toFixed(2)}" onchange="updateConfig('INMOB', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Hipoteca (%)</label>
                <input type="number" step="0.01" value="${(CONFIG.HIPOTECA * 100).toFixed(2)}" onchange="updateConfig('HIPOTECA', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Certificados (USD fijo)</label>
                <input type="number" value="${CONFIG.CERTIFICADOS}" onchange="updateConfig('CERTIFICADOS', parseInt(this.value))" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Margen referencia (%)</label>
                <input type="number" step="1" value="${(CONFIG.MARGEN_REF * 100).toFixed(0)}" onchange="updateConfig('MARGEN_REF', parseFloat(this.value)/100)" class="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
            </div>
          ` : ''}

          ${state.configTab === 'barrios' ? `
            <div class="mb-3">
              <button onclick="addBarrio()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">+ Agregar barrio</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-64 overflow-y-auto">
              ${Object.entries(REF_M2).sort((a,b) => a[0].localeCompare(b[0])).map(([barrio, valor]) => `
                <div class="flex items-center gap-2 bg-slate-50 rounded-lg p-2">
                  <input type="number" value="${valor}" onchange="updateRefM2('${escapeHtml(barrio)}', this.value)" class="w-20 px-2 py-1 border rounded text-sm" />
                  <span class="text-sm text-slate-600 flex-1 truncate" title="${escapeHtml(barrio)}">${escapeHtml(barrio)}</span>
                  <button onclick="deleteBarrio('${escapeHtml(barrio)}')" class="text-red-400 hover:text-red-600 text-sm">‚úï</button>
                </div>
              `).join('')}
            </div>
          ` : ''}

          ${state.configTab === 'pesos' ? `
            <!-- Tiers + Preferencias compacto -->
            <div class="flex flex-wrap items-center gap-2 text-xs mb-3">
              <span class="font-medium text-slate-600">Orden fijo:</span>
              <span class="bg-green-100 text-green-700 px-1.5 py-0.5 rounded">1. Activo+Apto+OK$</span>
              <span class="bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">2. Activo+Apto+Caro</span>
              <span class="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">3. Activo+NoApto</span>
              <span class="bg-red-100 text-red-700 px-1.5 py-0.5 rounded">4. Inactivo</span>
              <span class="text-slate-400 ml-2">‚Üí Dentro de cada capa ordena por:</span>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2">
              ${Object.entries(WEIGHTS).map(([key, config]) => `
                <div class="flex flex-col">
                  <div class="flex items-center justify-between text-xs mb-0.5">
                    <span class="text-slate-600 truncate" title="${config.desc}">${config.label}</span>
                    <span class="font-bold text-blue-600 ml-1">${config.weight}</span>
                  </div>
                  <input type="range" min="0" max="10" value="${config.weight}"
                    onchange="updateWeight('${key}', this.value)"
                    oninput="updateWeight('${key}', this.value)"
                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                </div>
              `).join('')}
            </div>
            <div class="mt-2 text-right">
              <button onclick="resetWeights()" class="text-xs text-slate-400 hover:text-red-500">Reset</button>
            </div>
          ` : ''}
        </div>
      `;
    }

    function render() {
      const properties = getProperties();
      const filtered = getFiltered(properties);
      const stats = getStats(properties);
      const barrios = [...new Set(properties.map(p => p.barrio).filter(Boolean))].sort();
      const selectedProp = state.selectedProperty !== null ? properties[state.selectedProperty] : null;

      const root = document.getElementById('root');
      root.innerHTML = `
        <!-- Fixed Header -->
        <header class="fixed top-0 left-0 right-0 bg-white shadow-md z-40">
          <!-- Status Bar -->
          <div class="bg-slate-800 text-white">
            <div class="max-w-7xl mx-auto px-4 py-1 flex items-center justify-between text-xs">
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-1.5">
                  ${state.loading
                    ? '<span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span><span class="text-yellow-300">Cargando...</span>'
                    : state.error
                      ? '<span class="w-2 h-2 bg-red-400 rounded-full"></span><span class="text-red-300">Error</span>'
                      : '<span class="w-2 h-2 bg-green-400 rounded-full"></span><span class="text-green-300">OK</span>'
                  }
                </div>
                ${state.lastUpdate ? `<span class="text-slate-400">¬∑ ${state.lastUpdate.toLocaleTimeString()}</span>` : ''}
                <span class="text-slate-500">${state.autoRefreshEnabled ? '¬∑ Auto ‚óè' : ''}</span>
              </div>
              <div class="text-slate-400">
                ${stats.total} props ¬∑ ${stats.activos} activas ¬∑ ${stats.entran} entran ¬∑ <span class="text-slate-600">v5-API</span>
              </div>
            </div>
          </div>

          <!-- Barra D√≥lar -->
          <div class="bg-slate-700 text-white">
            <div class="max-w-7xl mx-auto px-4 py-1 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-slate-400 text-xs">üíµ D√≥lar BNA</span>
                ${state.dolarBNA ? `
                  <span class="font-bold text-emerald-400">$${state.dolarBNA.venta}</span>
                  <span class="text-slate-500">|</span>
                  ${state.dolarBNA.variaciones ? `
                    <span class="text-xs ${parseFloat(state.dolarBNA.variaciones.dia) > 0 ? 'text-red-400' : parseFloat(state.dolarBNA.variaciones.dia) < 0 ? 'text-green-400' : 'text-slate-400'}">
                      1d: ${state.dolarBNA.variaciones.dia > 0 ? '+' : ''}${state.dolarBNA.variaciones.dia || '0'}%
                    </span>
                    <span class="text-slate-600">|</span>
                    <span class="text-xs ${parseFloat(state.dolarBNA.variaciones.semana) > 0 ? 'text-red-400' : parseFloat(state.dolarBNA.variaciones.semana) < 0 ? 'text-green-400' : 'text-slate-400'}">
                      7d: ${state.dolarBNA.variaciones.semana > 0 ? '+' : ''}${state.dolarBNA.variaciones.semana || '0'}%
                    </span>
                    <span class="text-slate-600">|</span>
                    <span class="text-xs ${parseFloat(state.dolarBNA.variaciones.mes) > 0 ? 'text-red-400' : parseFloat(state.dolarBNA.variaciones.mes) < 0 ? 'text-green-400' : 'text-slate-400'}">
                      30d: ${state.dolarBNA.variaciones.mes > 0 ? '+' : ''}${state.dolarBNA.variaciones.mes || '0'}%
                    </span>
                  ` : ''}
                ` : `
                  <span class="text-slate-500 text-xs">Cargando...</span>
                `}
              </div>
              <button onclick="cargarDolarHoy()" class="text-xs text-slate-400 hover:text-white transition-colors" ${state.loadingDolar ? 'disabled' : ''}>
                ${state.loadingDolar ? '...' : '‚Üª'}
              </button>
            </div>
          </div>

          <!-- Main Header -->
          <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-slate-800">üè† Casita Chiquis <span class="emoji-float text-sm">üë©‚ù§Ô∏èüßî‚Äç‚ôÇÔ∏èüê±üêà</span></h1>
                <nav class="flex bg-slate-100 rounded-lg p-1">
                  <span class="px-3 py-1.5 text-sm rounded-md bg-white shadow-sm text-slate-700 font-medium">Buscador</span>
                  <a href="stats.html" class="px-3 py-1.5 text-sm rounded-md text-slate-600 hover:bg-white/50">üìä Stats</a>
                </nav>
              </div>
              <div class="flex items-center gap-2">
                <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" target="_blank" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700" title="Abrir Google Sheet">üìù Sheet</a>
                <button onclick="fetchData()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 disabled:opacity-50" ${state.loading ? 'disabled' : ''} title="Actualizar datos">${state.loading ? '...' : '‚Üª'}</button>
                <button onclick="toggleAutoRefresh()" class="px-3 py-1.5 ${state.autoRefreshEnabled ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-700'} text-sm rounded-lg hover:opacity-80" title="Auto-refresh">${state.autoRefreshEnabled ? '‚è∏' : '‚ñ∂'}</button>
                <span class="w-px h-6 bg-slate-200"></span>
                <button onclick="state.showHelp=!state.showHelp;render()" class="px-3 py-1.5 ${state.showHelp ? 'bg-purple-500 text-white' : 'bg-slate-200 text-slate-700'} text-sm rounded-lg hover:opacity-80" title="Ayuda">?</button>
                <button onclick="state.showConfig=!state.showConfig;render()" class="px-3 py-1.5 ${state.showConfig ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-700'} text-sm rounded-lg hover:opacity-80" title="Config">‚öôÔ∏è</button>
              </div>
            </div>
            <p class="text-xs text-slate-500 mt-1">Cr√©dito $${getCreditoUSD().toLocaleString()} USD ¬∑ Tengo $${CONFIG.PRESUPUESTO.toLocaleString()} ¬∑ Busco $${getPrecioRange().min.toLocaleString()} - $${getPrecioRange().max.toLocaleString()}</p>
          </div>

          <!-- Config/Help panels inside header -->
          ${state.showConfig ? `<div class="border-t border-slate-200 bg-slate-50"><div class="max-w-7xl mx-auto px-4 py-3">${renderConfigPanel()}</div></div>` : ''}
          ${state.showHelp ? `<div class="border-t border-slate-200 bg-purple-50"><div class="max-w-7xl mx-auto px-4 py-3">${renderHelpPanel()}</div></div>` : ''}
        </header>

        <!-- Main Content -->
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-3 md:p-6 pt-40 md:pt-36">
          <div class="max-w-7xl mx-auto">

            ${state.error ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded-lg mb-4 text-sm">${escapeHtml(state.error)}</div>` : ''}

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 md:gap-3 mb-4">
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-slate-500">Total</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-green-600">${stats.entran}</div><div class="text-xs text-slate-500">Entran</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-red-600">${stats.total - stats.entran}</div><div class="text-xs text-slate-500">No entran</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-teal-600">${stats.activos}</div><div class="text-xs text-slate-500">Activos</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-purple-600">$${stats.minPrecio > 0 ? (stats.minPrecio/1000).toFixed(0) + 'k' : '-'}</div><div class="text-xs text-slate-500">Min</div></div>
              <div class="bg-white rounded-xl p-3 shadow-sm"><div class="text-xl md:text-2xl font-bold text-purple-600">$${stats.maxPrecio > 0 ? (stats.maxPrecio/1000).toFixed(0) + 'k' : '-'}</div><div class="text-xs text-slate-500">Max</div></div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl p-3 shadow-sm mb-4">
              <div class="flex flex-wrap gap-2 md:gap-3 items-center text-sm">
                <select onchange="state.filterStatus=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterStatus === 'todos' ? 'selected' : ''}>Status: Todos</option>
                  <option value="por ver" ${state.filterStatus === 'por ver' ? 'selected' : ''}>Por ver</option>
                  <option value="visitado" ${state.filterStatus === 'visitado' ? 'selected' : ''}>Visitado</option>
                  <option value="interesado" ${state.filterStatus === 'interesado' ? 'selected' : ''}>Interesado</option>
                  <option value="descartado" ${state.filterStatus === 'descartado' ? 'selected' : ''}>Descartado</option>
                </select>
                <select onchange="state.filterOk=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterOk === 'todos' ? 'selected' : ''}>A juntar: Todos</option>
                  <option value="ok" ${state.filterOk === 'ok' ? 'selected' : ''}>‚úì Me alcanza</option>
                  <option value="no" ${state.filterOk === 'no' ? 'selected' : ''}>‚úó No me alcanza</option>
                </select>
                <select onchange="state.filterBarrio=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterBarrio === 'todos' ? 'selected' : ''}>Barrio: Todos</option>
                  ${barrios.map(b => `<option value="${escapeHtml(b)}" ${state.filterBarrio === b ? 'selected' : ''}>${escapeHtml(b)}</option>`).join('')}
                </select>
                <select onchange="state.filterActivo=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                  <option value="todos" ${state.filterActivo === 'todos' ? 'selected' : ''}>Aviso: Todos</option>
                  <option value="si" ${state.filterActivo === 'si' ? 'selected' : ''}>‚úì Activo</option>
                  <option value="no" ${state.filterActivo === 'no' ? 'selected' : ''}>‚úó Baja</option>
                </select>
                <div class="flex items-center gap-1 ml-auto">
                  <select onchange="state.sortBy=this.value;render()" class="border border-slate-200 rounded-lg px-2 py-1.5 text-sm bg-white">
                    <option value="score" ${state.sortBy === 'score' ? 'selected' : ''}>‚≠ê Mejor candidato</option>
                    <option value="completeness" ${state.sortBy === 'completeness' ? 'selected' : ''}>Completitud</option>
                    <option value="precio" ${state.sortBy === 'precio' ? 'selected' : ''}>Precio</option>
                    <option value="total" ${state.sortBy === 'total' ? 'selected' : ''}>A juntar</option>
                    <option value="dif" ${state.sortBy === 'dif' ? 'selected' : ''}>Diferencia</option>
                    <option value="preciom2" ${state.sortBy === 'preciom2' ? 'selected' : ''}>$/m¬≤</option>
                  </select>
                  <button onclick="state.sortDir=state.sortDir==='asc'?'desc':'asc';render()" class="px-2 py-1.5 border border-slate-200 rounded-lg bg-white hover:bg-slate-50">${state.sortDir === 'asc' ? '‚Üë' : '‚Üì'}</button>
                </div>
                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden">
                  <button onclick="state.viewMode='cards';render()" class="px-2 py-1.5 text-sm ${state.viewMode === 'cards' ? 'bg-blue-500 text-white' : 'bg-white hover:bg-slate-50'}" title="Vista cards">üì±</button>
                  <button onclick="state.viewMode='auto';render()" class="px-2 py-1.5 text-sm ${state.viewMode === 'auto' ? 'bg-blue-500 text-white' : 'bg-white hover:bg-slate-50'}" title="Auto (cards en m√≥vil, tabla en desktop)">Auto</button>
                  <button onclick="state.viewMode='table';render()" class="px-2 py-1.5 text-sm ${state.viewMode === 'table' ? 'bg-blue-500 text-white' : 'bg-white hover:bg-slate-50'}" title="Vista tabla">üìä</button>
                </div>
                <span class="text-slate-400 text-xs">${filtered.length}/${properties.length}</span>
              </div>
            </div>

            <!-- Cards view (mobile or forced) -->
            <div class="${state.viewMode === 'cards' ? '' : state.viewMode === 'table' ? 'hidden' : 'md:hidden'}">
              ${renderCards(filtered)}
              ${filtered.length === 0 ? '<div class="text-center py-8 text-slate-400">No hay propiedades que coincidan</div>' : ''}
            </div>

            <!-- Table view (desktop or forced) -->
            <div class="${state.viewMode === 'table' ? '' : state.viewMode === 'cards' ? 'hidden' : 'hidden md:block'}">
              <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                      <tr>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600">Activo</th>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600" title="Apto Cr√©dito">Apto</th>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600">Status</th>
                        <th class="px-3 py-2.5 text-left font-medium text-slate-600">Direcci√≥n</th>
                        <th class="px-3 py-2.5 text-left font-medium text-slate-600">Barrio</th>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600">Tipo</th>
                        <th class="px-3 py-2.5 text-right font-medium text-slate-600">Precio</th>
                        <th class="px-2 py-2.5 text-right font-medium text-slate-600">m¬≤</th>
                        <th class="px-3 py-2.5 text-right font-medium text-slate-600">$/m¬≤</th>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600" title="Diferencia vs precio promedio del barrio">vs Ref</th>
                        <th class="px-3 py-2.5 text-right font-medium text-slate-600">A juntar</th>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600">OK</th>
                        <th class="px-2 py-2.5 text-center font-medium text-slate-600" title="Cocheras">üöó</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                      ${filtered.map((p, i) => {
                        const barColor = p._completeness >= 3 ? 'bg-green-500' : p._completeness >= 2 ? 'bg-yellow-500' : 'bg-red-400';
                        const isInactivo = (p.activo || '').toLowerCase() === 'no';
                        const noApto = (p.apto_credito || '').toLowerCase() !== 'si';
                        const rowBg = isInactivo ? 'bg-red-100/70 opacity-60' : noApto ? 'bg-amber-50/70' : (p._ok ? 'bg-green-50/30' : '');
                        return `
                        <tr class="hover:bg-slate-100 transition-colors cursor-pointer ${rowBg}" onclick="showDetail(${p._idx})">
                          <td class="px-2 py-2.5 text-center">${activoBadge(p.activo)}</td>
                          <td class="px-2 py-2.5 text-center">${aptoCreditoBadge(p.apto_credito)}</td>
                          <td class="px-2 py-2.5 text-center">${statusBadge(p.status)}</td>
                          <td class="px-3 py-2.5"><span class="font-medium text-slate-800">${p.direccion ? escapeHtml(p.direccion) : '<span class="text-slate-300 text-xs italic">sin dir</span>'}</span></td>
                          <td class="px-3 py-2.5 text-slate-600">${p.barrio ? escapeHtml(p.barrio) : '<span class="text-slate-300 text-xs italic">-</span>'}</td>
                          <td class="px-2 py-2.5 text-center text-xs text-slate-600">${p.tipo ? escapeHtml(p.tipo.toUpperCase()) : '<span class="text-slate-300">-</span>'}</td>
                          <td class="px-3 py-2.5 text-right font-mono text-slate-800">${p._precio > 0 ? '$' + p._precio.toLocaleString() : '<span class="text-slate-300">-</span>'}</td>
                          <td class="px-2 py-2.5 text-right text-slate-600">${p._m2 ? p._m2 : '<span class="text-slate-300">-</span>'}</td>
                          <td class="px-3 py-2.5 text-right font-mono text-slate-600">${p._preciom2 > 0 ? '$' + p._preciom2.toLocaleString() : '<span class="text-slate-300">-</span>'}</td>
                          <td class="px-2 py-2.5 text-center">${evalIcon(p._vsRef)}</td>
                          <td class="px-3 py-2.5 text-right font-mono text-slate-800">${p._precio > 0 ? '$' + p._total.toLocaleString() : '<span class="text-slate-300">-</span>'}</td>
                          <td class="px-2 py-2.5 text-center">${p._precio > 0 ? okPill(p._ok) : '<span class="text-slate-300">-</span>'}</td>
                          <td class="px-2 py-2.5 text-center">${p.cocheras ? (p.cocheras !== '0' ? '<span class="text-green-600">‚úì</span>' : '<span class="text-slate-300">-</span>') : '<span class="text-slate-300">-</span>'}</td>
                        </tr>
                      `;}).join('')}
                    </tbody>
                  </table>
                </div>
                ${filtered.length === 0 ? '<div class="text-center py-8 text-slate-400">No hay propiedades que coincidan</div>' : ''}
              </div>
            </div>

            
        ${selectedProp ? renderDetailModal(selectedProp) : ''}
      `;
    }

    // Initial load
    fetchData();
    startAutoRefresh();
    fetchDolarBNA().then(data => {
      if (data) {
        state.dolarBNA = data;
        render();
      }
    });
  </script>
</body>
</html>
