<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stats - Casita Chiquis</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Header (mismo que buscador) -->
  <header class="fixed top-0 left-0 right-0 bg-white shadow-md z-40">
    <!-- Status Bar -->
    <div class="bg-slate-800 text-white">
      <div class="max-w-7xl mx-auto px-4 py-1 flex items-center justify-between text-xs">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-1.5" id="statusIndicator">
            <span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
            <span class="text-yellow-300">Cargando...</span>
          </div>
        </div>
        <div class="text-slate-400" id="headerStats">-</div>
      </div>
    </div>

    <!-- Barra D√≥lar -->
    <div class="bg-slate-700 text-white">
      <div class="max-w-7xl mx-auto px-4 py-1 flex items-center justify-between">
        <div class="flex items-center gap-3" id="dolarBar">
          <span class="text-slate-400 text-xs">üíµ D√≥lar BNA</span>
          <span class="text-slate-500 text-xs">Cargando...</span>
        </div>
        <button onclick="cargarDolarHoy()" class="text-xs text-slate-400 hover:text-white">‚Üª</button>
      </div>
    </div>

    <!-- Main Header -->
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-bold text-slate-800">üè† Casita Chiquis</h1>
          <nav class="flex bg-slate-100 rounded-lg p-1">
            <a href="index.html" class="px-3 py-1.5 text-sm rounded-md text-slate-600 hover:bg-white/50">Buscador</a>
            <span class="px-3 py-1.5 text-sm rounded-md bg-white shadow-sm text-slate-700 font-medium">üìä Stats</span>
          </nav>
        </div>
        <div class="flex items-center gap-2">
          <a href="https://docs.google.com/spreadsheets/d/16n92ghEe8Vr1tiLdqbccF3i97kiwhHin9OPWY-O50L4" target="_blank" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700" title="Google Sheet">üìù Sheet</a>
          <button onclick="location.reload()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600" title="Actualizar">‚Üª</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-1" id="creditLine">Cargando config...</p>
    </div>
  </header>

  <div id="root" class="p-4 md:p-6 max-w-6xl mx-auto pt-28">

    <!-- Filtros -->
    <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <div class="flex flex-wrap items-center gap-4 mb-4">
        <h2 class="text-lg font-semibold text-slate-700">üîç Filtros</h2>

        <!-- Toggle Activo -->
        <div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1">
          <button onclick="setActivoFilter('todos')" id="btnTodos" class="px-3 py-1 text-sm rounded-md bg-white shadow-sm text-slate-700">Todos</button>
          <button onclick="setActivoFilter('activos')" id="btnActivos" class="px-3 py-1 text-sm rounded-md text-slate-600 hover:bg-white/50">Activos</button>
          <button onclick="setActivoFilter('inactivos')" id="btnInactivos" class="px-3 py-1 text-sm rounded-md text-slate-600 hover:bg-white/50">Inactivos</button>
        </div>

        <!-- Toggle Apto Cr√©dito -->
        <label class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200">
          <input type="checkbox" id="chkAptoCredito" onchange="toggleAptoCredito(this.checked)" checked class="rounded text-blue-500">
          <span class="text-sm text-slate-700">Mostrar no-apto cr√©dito</span>
        </label>

        <!-- Dropdown Tipo -->
        <select id="tipoFilter" onchange="setTipoFilter(this.value)" class="px-3 py-1.5 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 border-0">
          <option value="todos">Todos los tipos</option>
          <option value="depto">Depto</option>
          <option value="ph">PH</option>
          <option value="casa">Casa</option>
          <option value="duplex">Duplex</option>
          <option value="loft">Loft</option>
        </select>

        <!-- Dropdown Barrios -->
        <div class="relative">
          <button onclick="toggleBarrioDropdown()" class="px-3 py-1.5 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 flex items-center gap-2">
            <span id="barrioFilterLabel">Todos los barrios</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div id="barrioDropdown" class="hidden absolute z-10 mt-1 bg-white rounded-lg shadow-lg border border-slate-200 p-2 min-w-48 max-h-64 overflow-y-auto">
            <label class="flex items-center gap-2 px-2 py-1 hover:bg-slate-50 rounded cursor-pointer">
              <input type="checkbox" checked onchange="toggleAllBarrios(this.checked)" class="rounded text-blue-500">
              <span class="text-sm font-medium">Todos</span>
            </label>
            <hr class="my-1">
            <div id="barrioCheckboxes"></div>
          </div>
        </div>

        <span class="text-sm text-slate-500" id="filterCount"></span>
      </div>
    </div>


    <!-- Chart container -->
    <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <h2 class="text-lg font-semibold text-slate-700 mb-4" id="chartTitle">Precio vs M¬≤ cubiertos</h2>
      <div class="relative" style="height: 500px;">
        <canvas id="scatterChart"></canvas>
      </div>
      <div class="mt-4 flex flex-wrap gap-4 text-sm text-slate-600">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span>Apto cr√©dito - Entra</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span>Apto cr√©dito - No entra</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-0 h-0 border-l-[6px] border-r-[6px] border-b-[10px] border-l-transparent border-r-transparent border-b-amber-400"></span>
          <span>No apto cr√©dito</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-slate-400 opacity-50"></span>
          <span>Inactivo</span>
        </div>
      </div>
      <p class="mt-2 text-xs text-slate-400" id="chartHint">üí° Propiedades abajo-derecha = m√°s m¬≤ por menos precio = mejor valor</p>
    </div>

    <!-- Stats summary -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="statsGrid">
      <!-- Filled by JS -->
    </div>

  </div>

  <script>
    // Config (same as main page)
    const DEFAULT_CONFIG = {
      CREDITO_ARS: 126000000,
      DOLAR_BASE: 1450,
      PRESUPUESTO: 25000,
      ESCRIBANO: 0.0242,
      SELLOS_EXENTO: 140000,
      SELLOS: 0.0175,
      REGISTRALES: 0.004,
      INMOB: 0.0484,
      HIPOTECA: 0.01,
      CERTIFICADOS: 300,
    };

    const DEFAULT_REF_M2 = {
      "Flores": 1953, "Parque Chacabuco": 1951, "Liniers": 1857, "Monte Castro": 1854,
      "Floresta": 1683, "Parque Avellaneda": 1750, "Villa Luro": 1785, "V√©lez Sarsfield": 1663,
      "Mataderos": 1629, "Paternal": 1897, "Caballito": 2357, "Villa Crespo": 2150,
      "Villa del Parque": 2063, "Villa Devoto": 2348, "Boedo": 1876
    };

    function loadConfig() {
      try {
        const saved = localStorage.getItem('casita_config');
        if (saved) return { ...DEFAULT_CONFIG, ...JSON.parse(saved) };
        return { ...DEFAULT_CONFIG };
      } catch { return { ...DEFAULT_CONFIG }; }
    }

    function loadRefM2() {
      try {
        const saved = localStorage.getItem('casita_ref_m2');
        return saved ? JSON.parse(saved) : { ...DEFAULT_REF_M2 };
      } catch { return { ...DEFAULT_REF_M2 }; }
    }

    const CONFIG = loadConfig();
    const REF_M2 = loadRefM2();

    function getCreditoUSD() {
      return Math.round(CONFIG.CREDITO_ARS / CONFIG.DOLAR_BASE);
    }

    function getPrecioRange() {
      const credito = getCreditoUSD();
      const precioMin = Math.round(credito / 0.9);
      const gastosRate = CONFIG.ESCRIBANO + CONFIG.SELLOS + CONFIG.REGISTRALES + CONFIG.INMOB + CONFIG.HIPOTECA;
      const precioMax = Math.round((CONFIG.PRESUPUESTO + credito) / (1 + gastosRate));
      return { min: precioMin, max: precioMax };
    }

    // Actualizar l√≠nea de cr√©dito
    function updateCreditLine() {
      const el = document.getElementById('creditLine');
      if (el) {
        const range = getPrecioRange();
        el.textContent = `Cr√©dito $${getCreditoUSD().toLocaleString()} USD ¬∑ Tengo $${CONFIG.PRESUPUESTO.toLocaleString()} ¬∑ Busco $${range.min.toLocaleString()} - $${range.max.toLocaleString()}`;
      }
    }

    // Cargar d√≥lar BNA
    let dolarBNA = null;
    async function cargarDolarHoy() {
      try {
        const response = await fetch('https://api.bluelytics.com.ar/v2/evolution.json');
        if (!response.ok) throw new Error('API error');
        const allData = await response.json();
        const oficial = allData.filter(d => d.source === 'Oficial');
        if (oficial.length === 0) throw new Error('No data');
        oficial.sort((a, b) => new Date(b.date) - new Date(a.date));
        const hoy = oficial[0];
        const hace7d = oficial.find(d => new Date(d.date) <= new Date(Date.now() - 7*24*60*60*1000));
        const hace30d = oficial.find(d => new Date(d.date) <= new Date(Date.now() - 30*24*60*60*1000));

        dolarBNA = {
          venta: hoy.value_sell,
          variaciones: {
            dia: oficial[1] ? ((hoy.value_sell - oficial[1].value_sell) / oficial[1].value_sell * 100).toFixed(1) : '0',
            mes: hace30d ? ((hoy.value_sell - hace30d.value_sell) / hace30d.value_sell * 100).toFixed(1) : '0'
          }
        };
        updateDolarBar();
      } catch (e) {
        console.error('Error cargando d√≥lar:', e);
      }
    }

    function updateDolarBar() {
      const el = document.getElementById('dolarBar');
      if (!el || !dolarBNA) return;
      const varDia = parseFloat(dolarBNA.variaciones.dia);
      const varMes = parseFloat(dolarBNA.variaciones.mes);
      el.innerHTML = `
        <span class="text-slate-400 text-xs">üíµ D√≥lar BNA</span>
        <span class="font-bold text-emerald-400">$${dolarBNA.venta}</span>
        <span class="text-slate-500">|</span>
        <span class="text-xs ${varDia > 0 ? 'text-red-400' : varDia < 0 ? 'text-green-400' : 'text-slate-400'}">
          1d: ${varDia > 0 ? '+' : ''}${dolarBNA.variaciones.dia}%
        </span>
        <span class="text-slate-600">|</span>
        <span class="text-xs ${varMes > 0 ? 'text-red-400' : varMes < 0 ? 'text-green-400' : 'text-slate-400'}">
          30d: ${varMes > 0 ? '+' : ''}${dolarBNA.variaciones.mes}%
        </span>
      `;
    }

    function updateStatusIndicator(loading, error = false, count = 0) {
      const el = document.getElementById('statusIndicator');
      const statsEl = document.getElementById('headerStats');
      if (el) {
        if (loading) {
          el.innerHTML = '<span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span><span class="text-yellow-300">Cargando...</span>';
        } else if (error) {
          el.innerHTML = '<span class="w-2 h-2 bg-red-400 rounded-full"></span><span class="text-red-300">Error</span>';
        } else {
          el.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full"></span><span class="text-green-300">OK</span>';
        }
      }
      if (statsEl && count > 0) {
        statsEl.textContent = `${count} propiedades`;
      }
    }

    const API_KEY = 'AIzaSyClZvK5NbmLEtxi9tqf1fcKxRIKEUqYnu0';
    const SHEET_ID = '16n92ghEe8Vr1tiLdqbccF3i97kiwhHin9OPWY-O50L4';

    let chart = null;
    let allProperties = [];
    let activoFilter = 'todos'; // 'todos', 'activos', 'inactivos'
    let showNoAptoCredito = true; // mostrar todos por defecto
    let selectedBarrios = new Set(); // empty = all
    let tipoFilter = 'todos'; // 'todos', 'depto', 'ph', 'casa', etc.

    // Filter functions
    function setActivoFilter(filter) {
      activoFilter = filter;
      ['btnTodos', 'btnActivos', 'btnInactivos'].forEach(id => {
        const btn = document.getElementById(id);
        const isActive = (id === 'btnTodos' && filter === 'todos') ||
                        (id === 'btnActivos' && filter === 'activos') ||
                        (id === 'btnInactivos' && filter === 'inactivos');
        btn.className = isActive
          ? 'px-3 py-1 text-sm rounded-md bg-white shadow-sm text-slate-700'
          : 'px-3 py-1 text-sm rounded-md text-slate-600 hover:bg-white/50';
      });
      recalculateAndRender();
    }

    function toggleAptoCredito(checked) {
      showNoAptoCredito = checked;
      recalculateAndRender();
    }

    function setTipoFilter(tipo) {
      tipoFilter = tipo;
      recalculateAndRender();
    }

    function toggleBarrioDropdown() {
      document.getElementById('barrioDropdown').classList.toggle('hidden');
    }

    function toggleAllBarrios(checked) {
      const checkboxes = document.querySelectorAll('#barrioCheckboxes input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = checked);
      selectedBarrios = checked ? new Set() : new Set(['__none__']);
      updateBarrioLabel();
      recalculateAndRender();
    }

    function toggleBarrio(barrio, checked) {
      if (selectedBarrios.size === 0) {
        // Was "all", now selecting specific ones
        const allBarrios = [...new Set(allProperties.map(p => p.barrio).filter(Boolean))];
        selectedBarrios = new Set(allBarrios);
      }
      if (checked) {
        selectedBarrios.add(barrio);
      } else {
        selectedBarrios.delete(barrio);
      }
      // If all selected, reset to empty (means all)
      const allBarrios = [...new Set(allProperties.map(p => p.barrio).filter(Boolean))];
      if (selectedBarrios.size === allBarrios.length) {
        selectedBarrios = new Set();
      }
      updateBarrioLabel();
      recalculateAndRender();
    }

    function updateBarrioLabel() {
      const label = document.getElementById('barrioFilterLabel');
      if (selectedBarrios.size === 0) {
        label.textContent = 'Todos los barrios';
      } else if (selectedBarrios.size === 1) {
        label.textContent = [...selectedBarrios][0];
      } else {
        label.textContent = `${selectedBarrios.size} barrios`;
      }
    }

    function renderBarrioCheckboxes() {
      const barrios = [...new Set(allProperties.map(p => p.barrio).filter(Boolean))].sort();
      const container = document.getElementById('barrioCheckboxes');
      container.innerHTML = barrios.map(barrio => `
        <label class="flex items-center gap-2 px-2 py-1 hover:bg-slate-50 rounded cursor-pointer">
          <input type="checkbox" checked onchange="toggleBarrio('${barrio}', this.checked)" class="rounded text-blue-500">
          <span class="text-sm">${barrio}</span>
        </label>
      `).join('');
    }

    function getFilteredProperties() {
      return allProperties.filter(p => {
        // Activo filter
        const activo = (p.activo || '').toLowerCase();
        if (activoFilter === 'activos' && activo !== 'si') return false;
        if (activoFilter === 'inactivos' && activo !== 'no') return false;
        // Apto cr√©dito filter - hide non-apto unless toggle is on
        if (!showNoAptoCredito) {
          const aptoCredito = (p.apto_credito || '').toLowerCase();
          if (aptoCredito !== 'si') return false;
        }
        // Tipo filter
        if (tipoFilter !== 'todos') {
          const tipo = (p.tipo || '').toLowerCase();
          if (tipo !== tipoFilter) return false;
        }
        // Barrio filter
        if (selectedBarrios.size > 0 && !selectedBarrios.has(p.barrio)) return false;
        return true;
      });
    }

    function updateFilterCount() {
      const filtered = getFilteredProperties();
      const total = allProperties.length;
      document.getElementById('filterCount').textContent =
        filtered.length === total ? '' : `${filtered.length} de ${total} propiedades`;
    }

    function recalculateAndRender() {
      if (allProperties.length > 0) {
        const filtered = getFilteredProperties();
        renderChart(filtered);
        renderStats(filtered);
        updateFilterCount();
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('barrioDropdown');
      const btn = e.target.closest('button');
      if (!dropdown.contains(e.target) && !btn?.onclick?.toString().includes('toggleBarrioDropdown')) {
        dropdown.classList.add('hidden');
      }
    });

    async function fetchData() {
      const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:AH?key=${API_KEY}`;

      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('API error');
        const data = await response.json();

        if (!data.values || data.values.length < 2) throw new Error('No data');

        const headers = data.values[0].map(h => h.toLowerCase().replace(/\s+/g, '_'));
        const rows = data.values.slice(1)
          .map((row, idx) => {
            const obj = { _idx: idx };
            headers.forEach((h, i) => { obj[h] = row[i] || ''; });
            return obj;
          })
          .filter(row => row.direccion || row.barrio || row.link);

        return rows.map(calculateProperty);
      } catch (err) {
        console.error('Error:', err);
        return [];
      }
    }

    function calculateProperty(p) {
      const precio = parseFloat(p.precio) || 0;
      const m2 = parseFloat(p.m2_cub) || 0;
      const barrio = p.barrio;
      const tieneInmob = p.inmobiliaria && p.inmobiliaria.trim() !== '';
      const creditoUSD = getCreditoUSD();

      const calc = {
        ...p,
        _precio: precio,
        _m2: m2,
        _preciom2: m2 > 0 ? Math.round(precio / m2) : 0,
        _ref: REF_M2[barrio] || 0
      };

      calc._vsRef = (calc._preciom2 > 0 && calc._ref > 0)
        ? (calc._preciom2 - calc._ref) / calc._ref
        : null;
      calc._tu10 = Math.max(precio - creditoUSD, precio * 0.1);
      calc._escr = Math.round(precio * CONFIG.ESCRIBANO);
      calc._sell = precio <= CONFIG.SELLOS_EXENTO ? 0 : Math.round(precio * CONFIG.SELLOS);
      calc._reg = Math.round(precio * CONFIG.REGISTRALES);
      calc._inmob = tieneInmob ? Math.round(precio * CONFIG.INMOB) : 0;
      calc._hip = Math.round(precio * CONFIG.HIPOTECA);
      calc._cert = CONFIG.CERTIFICADOS;
      calc._total = calc._tu10 + calc._escr + calc._sell + calc._reg + calc._inmob + calc._hip + calc._cert;
      calc._ok = calc._total <= CONFIG.PRESUPUESTO;

      return calc;
    }

    function renderChart(properties) {
      const ctx = document.getElementById('scatterChart').getContext('2d');

      // Filter properties with price and m2
      const validProps = properties.filter(p => p._precio > 0 && p._m2 > 0);

      const data = validProps.map(p => {
        const activo = (p.activo || '').toLowerCase() === 'si';
        const aptoCredito = (p.apto_credito || '').toLowerCase() === 'si';
        return {
          x: p._m2,
          y: p._precio,
          label: p.direccion || 'Sin direcci√≥n',
          barrio: p.barrio || 'Sin barrio',
          preciom2: p._preciom2,
          ok: p._ok,
          vsRef: p._vsRef,
          activo: activo,
          aptoCredito: aptoCredito
        };
      });

      // Calculate trend line
      const n = data.length;
      if (n > 1) {
        const sumX = data.reduce((a, b) => a + b.x, 0);
        const sumY = data.reduce((a, b) => a + b.y, 0);
        const sumXY = data.reduce((a, b) => a + b.x * b.y, 0);
        const sumX2 = data.reduce((a, b) => a + b.x * b.x, 0);

        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        const minX = Math.min(...data.map(d => d.x));
        const maxX = Math.max(...data.map(d => d.x));

        var trendData = [
          { x: minX, y: slope * minX + intercept },
          { x: maxX, y: slope * maxX + intercept }
        ];
      }

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Propiedades',
              data: data,
              backgroundColor: data.map(d => {
                if (!d.activo) return 'rgba(148, 163, 184, 0.4)'; // Inactivo: gris
                if (!d.aptoCredito) return 'rgba(251, 191, 36, 0.4)'; // No apto: amarillo tenue
                return d.ok ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)';
              }),
              borderColor: data.map(d => {
                if (!d.activo) return 'rgb(100, 116, 139)'; // Inactivo: gris oscuro
                if (!d.aptoCredito) return 'rgb(217, 119, 6)'; // No apto: amarillo oscuro
                return d.ok ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)';
              }),
              borderWidth: data.map(d => (d.activo && d.aptoCredito) ? 2 : 1),
              borderDash: data.map(d => d.activo ? [] : [3, 3]),
              pointRadius: data.map(d => (d.activo && d.aptoCredito) ? 8 : 6),
              pointHoverRadius: 12,
              pointStyle: data.map(d => {
                if (!d.activo) return 'crossRot';
                if (!d.aptoCredito) return 'triangle';
                return 'circle';
              }),
            },
            {
              label: 'Tendencia',
              data: trendData || [],
              type: 'line',
              borderColor: 'rgba(100, 116, 139, 0.5)',
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const d = context.raw;
                  const vsRef = d.vsRef !== null ? ` (${d.vsRef > 0 ? '+' : ''}${Math.round(d.vsRef * 100)}% vs barrio)` : '';
                  const warnings = [];
                  if (!d.activo) warnings.push('INACTIVO');
                  if (!d.aptoCredito) warnings.push('NO APTO CR√âDITO');
                  const status = warnings.length > 0 ? ' ‚ö†Ô∏è ' + warnings.join(', ') : '';
                  return [
                    d.label + status,
                    d.barrio,
                    `$${d.y.toLocaleString()} ¬∑ ${d.x}m¬≤`,
                    `$${d.preciom2.toLocaleString()}/m¬≤${vsRef}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'M¬≤ cubiertos',
                font: { weight: 'bold' }
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Precio (USD)',
                font: { weight: 'bold' }
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + (value / 1000) + 'k';
                }
              }
            }
          }
        }
      });
    }

    function renderStats(properties) {
      const valid = properties.filter(p => p._precio > 0);
      const withM2 = valid.filter(p => p._m2 > 0);

      const stats = {
        total: properties.length,
        conPrecio: valid.length,
        entran: valid.filter(p => p._ok).length,
        avgPrecio: valid.length > 0 ? Math.round(valid.reduce((a, b) => a + b._precio, 0) / valid.length) : 0,
        avgM2: withM2.length > 0 ? Math.round(withM2.reduce((a, b) => a + b._m2, 0) / withM2.length) : 0,
        avgPrecioM2: withM2.length > 0 ? Math.round(withM2.reduce((a, b) => a + b._preciom2, 0) / withM2.length) : 0,
        minPrecio: valid.length > 0 ? Math.min(...valid.map(p => p._precio)) : 0,
        maxPrecio: valid.length > 0 ? Math.max(...valid.map(p => p._precio)) : 0,
      };

      document.getElementById('statsGrid').innerHTML = `
        <div class="bg-white rounded-xl p-4 shadow-sm">
          <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
          <div class="text-xs text-slate-500">Total propiedades</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
          <div class="text-2xl font-bold text-green-600">${stats.entran}</div>
          <div class="text-xs text-slate-500">Entran en presupuesto</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
          <div class="text-2xl font-bold text-purple-600">$${stats.avgPrecioM2.toLocaleString()}</div>
          <div class="text-xs text-slate-500">$/m¬≤ promedio</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
          <div class="text-2xl font-bold text-slate-600">${stats.avgM2}m¬≤</div>
          <div class="text-xs text-slate-500">M¬≤ promedio</div>
        </div>
      `;
    }

    // Initialize
    async function init() {
      // Cargar header
      updateCreditLine();
      cargarDolarHoy();

      // Cargar datos
      updateStatusIndicator(true);
      try {
        const properties = await fetchData();
        allProperties = properties;
        updateStatusIndicator(false, false, properties.length);

        renderBarrioCheckboxes();
        recalculateAndRender();
      } catch (e) {
        updateStatusIndicator(false, true);
        console.error('Error:', e);
      }
    }

    init();
  </script>
</body>
</html>
